<!doctype html><html lang=cn dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Node.js 速览笔记 &#183; 武妖妖</title>
<meta name=title content="Node.js 速览笔记 &#183; 武妖妖"><meta name=description content="My awesome website"><link rel=canonical href=https://hunger-511.github.io/hunger-blog/technology/nodejs/nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0/><link rel=alternate type=application/rss+xml href=/hunger-blog/technology/nodejs/nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0/index.xml title=武妖妖><link type=text/css rel=stylesheet href=/hunger-blog/css/main.bundle.min.85f006de1806b55b2d082d1122deedd8cec6fdc1f7c8a51be975a4496165d6c798f4a3de52545a6a87cc4bc09fc2d6f5201d44ea57acc1ac2b1c42a688c62bee.css integrity="sha512-hfAG3hgGtVstCC0RIt7t2M7G/cH3yKUb6XWkSWFl1seY9KPeUlRaaofMS8Cfwtb1IB1E6leswawrHEKmiMYr7g=="><script type=text/javascript src=/hunger-blog/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/hunger-blog/js/main.bundle.min.3bf932fb486c7c6b0e9212c39dce2b9d397b5e8ebf40e117ac2abe19286dda4c56e894dc013de92d0713ba7d094a222ac5b14a2aeef988b7f9856a6ef6a26183.js integrity="sha512-O/ky+0hsfGsOkhLDnc4rnTl7Xo6/QOEXrCq+GSht2kxW6JTcAT3pLQcTun0JSiIqxbFKKu75iLf5hWpu9qJhgw==" data-copy data-copied></script><script src=/hunger-blog/js/zoom.min.js></script><link rel=apple-touch-icon sizes=180x180 href=/hunger-blog/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/hunger-blog/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/hunger-blog/favicon-16x16.png><link rel=manifest href=/hunger-blog/site.webmanifest><meta property="og:title" content="Node.js 速览笔记"><meta property="og:description" content="My awesome website"><meta property="og:type" content="website"><meta property="og:url" content="https://hunger-511.github.io/hunger-blog/technology/nodejs/nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0/"><meta property="og:image" content="https://hunger-511.github.io/hunger-blog/technology/nodejs/nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0/feature-nodejs2.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hunger-511.github.io/hunger-blog/technology/nodejs/nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0/feature-nodejs2.jpg"><meta name=twitter:title content="Node.js 速览笔记"><meta name=twitter:description content="My awesome website"><meta name=author content="Hunger"><link href=https://github.com/hunger-511 rel=me><script src=/hunger-blog/lib/jquery/jquery.slim.min.js integrity></script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/hunger-blog/ class="text-base font-medium text-gray-500 hover:text-gray-900">武妖妖</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/hunger-blog/storeroom/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><p class="text-base font-medium" title=511号储物间>储物间</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><!doctype html><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="16pt" height="16pt" viewBox="0 0 16 16"><g transform="translate(0.000000,16.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M46 129c-13-19-13-24 0-36 18-18 18-21-1-39-8-9-15-21-15-27s7-1 16 11c19 28 49 28 68 0 9-12 16-17 16-11s-7 18-15 27c-19 18-19 21-1 39 13 12 13 17 0 36-8 11-24 21-34 21s-26-10-34-21zm62-6c2-9-7-13-27-13-30 0-39 9-24 24 11 10 46 3 51-11zM92 88c-9-9-15-9-24 0s-7 12 12 12 21-3 12-12z"/></g></svg></span></span><a href=/hunger-blog/technology/ class="text-base font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title=编程学习>技术
</a><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/hunger-blog/technology/nodejs/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.0234375c-.263125.0-.5257656.0690312-.7597656.2070313l-4.5 2.6484374C2.2832344 4.1469063 2 4.642875 2 5.171875v5.833984C2 11.554859 2.29925 12.059266 2.78125 12.322266l1.4746094.804687C4.4828594 13.250953 4.7286094 13.310547 4.9746094 13.310547 5.2386094 13.310547 5.4992812 13.239609 5.7382812 13.099609c.46-.273.734375-.755014999999998.734375-1.291015V5.4648438h-1V11.808594C5.4726562 12.065594 5.3025156 12.195281 5.2285156 12.238281 5.1555156 12.281281 4.959375 12.371047 4.734375 12.248047l-1.4726562-.802735C3.1007187 11.357312 3 11.188859 3 11.005859V5.171875c0-.176.0940938-.3416406.2460938-.4316406l4.5-2.6484375C7.9020937 1.9997969 8.0979062 2.0007969 8.2539062 2.0917969L12.753906 4.7402344C12.904906 4.8302344 13 4.995875 13 5.171875v5.837891C13 11.189766 12.900234 11.359219 12.740234 11.449219L8.2402344 13.900391C8.0902344 13.980391 7.9097656 13.980391 7.7597656 13.900391L6.8808594 13.419922C6.7108594 13.629922 6.5 13.810937 6.25 13.960938 6.17 14.010938 6.0897656 14.050078 6.0097656 14.080078L7.2792969 14.779297C7.5092969 14.899297 7.75 14.960938 8 14.960938S8.4907031 14.899297 8.7207031 14.779297l4.4999999-2.458985C13.700703 12.060313 14 11.559766 14 11.009766V5.171875C14 4.642875 13.717719 4.1469062 13.261719 3.8789062L8.7617188 1.2304688C8.5272187 1.0924688 8.263125 1.0234375 8 1.0234375zM9.4511719 5.3183594c-1.58.0-2.3808594.5507187-2.3808594 1.6367187.0 1.23 1.4166562 1.413 2.0976563 1.5C9.2659688 8.4680781 9.352875 8.4791875 9.421875 8.4921875L9.7207031 8.5449219C10.760703 8.7189219 11 8.836875 11 9.171875 11 9.333875 10.999172 9.8242188 9.4511719 9.8242188c-1.313.0-1.5820313-.389609400000001-1.5820313-.9746094h-1c0 .901999999999999.4480313 1.9746096 2.5820313 1.9746096C11.557172 10.824219 12 9.925875 12 9.171875c0-1.258-1.222281-1.4642344-2.1132812-1.6152344L9.5996094 7.5078125C9.5166094 7.4928125 9.4119219 7.4788438 9.2949219 7.4648438 8.6589219 7.3828438 8.0703125 7.2650312 8.0703125 6.9570312 8.0703125 6.7340313 8.0691719 6.3193594 9.4511719 6.3183594c.9190001.0 1.3867191.3024375 1.3867191.8984375h1c0-.917000000000001-.628719-1.8984375-2.3867191-1.8984375z"/></svg></span></span><p class="text-sm font-sm" title=Node.js>NodeJS</p></a><a href=/hunger-blog/technology/explore/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><!doctype html><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="48pt" height="48pt" viewBox="0 0 48 48"><g transform="translate(0.000000,48.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M143 370c-56-12-1e2-35-118-64-40-61-23-149 37-186 43-26 62-25 125 7l53 26 53-26c63-32 82-33 125-7 60 37 77 125 37 187-26 39-94 63-188 68-45 2-101 0-124-5z"/></g></svg></span></span><p class="text-sm font-sm" title=探索尝鲜>探索</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/hunger-blog/storeroom/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></div><p class="text-bg font-bg" title=511号储物间>储物间</p></a></li><li class=mt-1><a class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><!doctype html><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="16pt" height="16pt" viewBox="0 0 16 16"><g transform="translate(0.000000,16.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M46 129c-13-19-13-24 0-36 18-18 18-21-1-39-8-9-15-21-15-27s7-1 16 11c19 28 49 28 68 0 9-12 16-17 16-11s-7 18-15 27c-19 18-19 21-1 39 13 12 13 17 0 36-8 11-24 21-34 21s-26-10-34-21zm62-6c2-9-7-13-27-13-30 0-39 9-24 24 11 10 46 3 51-11zM92 88c-9-9-15-9-24 0s-7 12 12 12 21-3 12-12z"/></g></svg></span></span><p class="text-bg font-bg" title=编程学习>技术</p><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=/hunger-blog/technology/nodejs/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 1.0234375c-.263125.0-.5257656.0690312-.7597656.2070313l-4.5 2.6484374C2.2832344 4.1469063 2 4.642875 2 5.171875v5.833984C2 11.554859 2.29925 12.059266 2.78125 12.322266l1.4746094.804687C4.4828594 13.250953 4.7286094 13.310547 4.9746094 13.310547 5.2386094 13.310547 5.4992812 13.239609 5.7382812 13.099609c.46-.273.734375-.755014999999998.734375-1.291015V5.4648438h-1V11.808594C5.4726562 12.065594 5.3025156 12.195281 5.2285156 12.238281 5.1555156 12.281281 4.959375 12.371047 4.734375 12.248047l-1.4726562-.802735C3.1007187 11.357312 3 11.188859 3 11.005859V5.171875c0-.176.0940938-.3416406.2460938-.4316406l4.5-2.6484375C7.9020937 1.9997969 8.0979062 2.0007969 8.2539062 2.0917969L12.753906 4.7402344C12.904906 4.8302344 13 4.995875 13 5.171875v5.837891C13 11.189766 12.900234 11.359219 12.740234 11.449219L8.2402344 13.900391C8.0902344 13.980391 7.9097656 13.980391 7.7597656 13.900391L6.8808594 13.419922C6.7108594 13.629922 6.5 13.810937 6.25 13.960938 6.17 14.010938 6.0897656 14.050078 6.0097656 14.080078L7.2792969 14.779297C7.5092969 14.899297 7.75 14.960938 8 14.960938S8.4907031 14.899297 8.7207031 14.779297l4.4999999-2.458985C13.700703 12.060313 14 11.559766 14 11.009766V5.171875C14 4.642875 13.717719 4.1469062 13.261719 3.8789062L8.7617188 1.2304688C8.5272187 1.0924688 8.263125 1.0234375 8 1.0234375zM9.4511719 5.3183594c-1.58.0-2.3808594.5507187-2.3808594 1.6367187.0 1.23 1.4166562 1.413 2.0976563 1.5C9.2659688 8.4680781 9.352875 8.4791875 9.421875 8.4921875L9.7207031 8.5449219C10.760703 8.7189219 11 8.836875 11 9.171875 11 9.333875 10.999172 9.8242188 9.4511719 9.8242188c-1.313.0-1.5820313-.389609400000001-1.5820313-.9746094h-1c0 .901999999999999.4480313 1.9746096 2.5820313 1.9746096C11.557172 10.824219 12 9.925875 12 9.171875c0-1.258-1.222281-1.4642344-2.1132812-1.6152344L9.5996094 7.5078125C9.5166094 7.4928125 9.4119219 7.4788438 9.2949219 7.4648438 8.6589219 7.3828438 8.0703125 7.2650312 8.0703125 6.9570312 8.0703125 6.7340313 8.0691719 6.3193594 9.4511719 6.3183594c.9190001.0 1.3867191.3024375 1.3867191.8984375h1c0-.917000000000001-.628719-1.8984375-2.3867191-1.8984375z"/></svg></span></span><p class="text-sm font-small" title=Node.js>NodeJS</p></a></li><li class=mt-1><a href=/hunger-blog/technology/explore/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><!doctype html><svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="48pt" height="48pt" viewBox="0 0 48 48"><g transform="translate(0.000000,48.000000) scale(0.100000,-0.100000)" fill="#000" stroke="none"><path d="M143 370c-56-12-1e2-35-118-64-40-61-23-149 37-186 43-26 62-25 125 7l53 26 53-26c63-32 82-33 125-7 60 37 77 125 37 187-26 39-94 63-188 68-45 2-101 0-124-5z"/></g></svg></span></span><p class="text-sm font-small" title=探索尝鲜>探索</p></a></li><li class=mb-2></li></ul></div></label></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/hunger-blog/technology/nodejs/nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0/feature-nodejs2_hu5a241a1340e8a83a34727b66210fd556_332077_1200x0_resize_q75_box.jpg)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><header><h1 class="mt-5 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Node.js 速览笔记</h1><div class="mt-1 mb-2 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"></div></div><script>var oid="views_technology/nodejs/nodejs速览笔记/_index.md",oid_likes="likes_technology/nodejs/nodejs速览笔记/_index.md"</script><script type=text/javascript src=/hunger-blog/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script></header><section class="mt-0 prose flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-prose"><h4 class="relative group">一、Node.js基础<div id=%E4%B8%80nodejs%E5%9F%BA%E7%A1%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%B8%80nodejs%E5%9F%BA%E7%A1%80 aria-label=Anchor>#</a></span></h4><h5 class="relative group">1. 认识Node.js<div id=1--%E8%AE%A4%E8%AF%86nodejs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1--%E8%AE%A4%E8%AF%86nodejs aria-label=Anchor>#</a></span></h5><blockquote><p>Node.js是一个javascript运行环境。它让javascript可以开发后端程序，实现几乎其他后端语言实现的所有功能，可以与PHP、Java、Python、.NET、Ruby等后端语言平起平坐。</p><p>Nodejs是基于V8引擎，V8是Google发布的开源JavaScript引擎，本身就是用于Chrome浏览器的js解释部分，但是Ryan Dahl 这哥们，鬼才般的，把这个V8搬到了服务器上，用于做服务器的软件。</p></blockquote><h6 class="relative group">01 nodejs的特性<div id=01-nodejs%E7%9A%84%E7%89%B9%E6%80%A7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#01-nodejs%E7%9A%84%E7%89%B9%E6%80%A7 aria-label=Anchor>#</a></span></h6><ul><li>Nodejs语法完全是js语法，只要你懂js基础就可以学会Nodejs后端开发</li><li>NodeJs超强的高并发能力,实现高性能服务器</li><li>开发周期短、开发成本低、学习成本低</li></ul><h6 class="relative group">02 使用 Node.js 需要了解多少 JavaScript<div id=02-%E4%BD%BF%E7%94%A8-nodejs-%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E5%A4%9A%E5%B0%91-javascript class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#02-%E4%BD%BF%E7%94%A8-nodejs-%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3%E5%A4%9A%E5%B0%91-javascript aria-label=Anchor>#</a></span></h6><blockquote><p><a href=http://nodejs.cn/learn/how-much-javascript-do-you-need-to-know-to-use-nodejs target=_blank>http://nodejs.cn/learn/how-much-javascript-do-you-need-to-know-to-use-nodejs</a></p></blockquote><h6 class="relative group">03 浏览器环境vs node环境<div id=03-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%8E%AF%E5%A2%83vs-node%E7%8E%AF%E5%A2%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#03-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%8E%AF%E5%A2%83vs-node%E7%8E%AF%E5%A2%83 aria-label=Anchor>#</a></span></h6><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220209152247426.png alt=image-20220209152247426></figure></p><p>Node.js 可以解析JS代码（没有浏览器安全级别的限制）提供很多系统级别的API，如：</p><ul><li><p>文件的读写 (File System)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;./ajax.png&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>content</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div></li><li><p>进程的管理 (Process)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>main</span><span class=p>(</span><span class=nx>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>argv</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span></code></pre></div></li><li><p>网络通信 (HTTP/HTTPS)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;http&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;content-type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/plain&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s2>&#34;hello nodejs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div></li></ul><h5 class="relative group">2. 开发环境搭建<div id=2--%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2--%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA aria-label=Anchor>#</a></span></h5><blockquote><p><a href=http://nodejs.cn/download/ target=_blank>http://nodejs.cn/download/</a></p></blockquote><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220210095903409.png alt=image-20220210095903409></figure></p><h5 class="relative group">3. 模块、包、commonJS<div id=3--%E6%A8%A1%E5%9D%97%E5%8C%85commonjs class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3--%E6%A8%A1%E5%9D%97%E5%8C%85commonjs aria-label=Anchor>#</a></span></h5><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220210100015768.png alt=image-20220210100015768></figure></p><h6 class="relative group">02 CommonJS规范<div id=02-commonjs%E8%A7%84%E8%8C%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#02-commonjs%E8%A7%84%E8%8C%83 aria-label=Anchor>#</a></span></h6><img src=nodejs速览笔记.assets/image-20220210101652166.png alt=image-20220210101652166 style=zoom:67%>
<img src=nodejs速览笔记.assets/image-20220210101720533.png alt=image-20220210101720533 style=zoom:67%><h6 class="relative group">03 modules模块化规范写法<div id=03-modules%E6%A8%A1%E5%9D%97%E5%8C%96%E8%A7%84%E8%8C%83%E5%86%99%E6%B3%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#03-modules%E6%A8%A1%E5%9D%97%E5%8C%96%E8%A7%84%E8%8C%83%E5%86%99%E6%B3%95 aria-label=Anchor>#</a></span></h6><p>我们可以把公共的功能 抽离成为一个单独的 js 文件 作为一个模块，默认情况下面这个模块里面的方法或者属性，外面是没法访问的。如果要让外部可以访问模块里面的方法或者属性，就必须在模块里面通过 exports 或者 module.exports 暴露属性或者方法。</p><p>m1.js：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=s1>&#39;gp19&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sayName</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;module 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 接口暴露方法一：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>say</span><span class=o>:</span> <span class=nx>sayName</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 接口暴露方法二：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>exports</span><span class=p>.</span><span class=nx>say</span> <span class=o>=</span> <span class=nx>sayName</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 错误！
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>say</span><span class=o>:</span> <span class=nx>sayName</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>main.js：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>m1</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./m1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>m1</span><span class=p>.</span><span class=nx>say</span><span class=p>()</span>
</span></span></code></pre></div><h5 class="relative group">4. Npm&amp;Yarn<div id=4--npmyarn class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4--npmyarn aria-label=Anchor>#</a></span></h5><h6 class="relative group">01 npm的使用<div id=01-npm%E7%9A%84%E4%BD%BF%E7%94%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#01-npm%E7%9A%84%E4%BD%BF%E7%94%A8 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>init</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>install</span> <span class=nx>包名</span> <span class=err>–</span><span class=nx>g</span>  <span class=err>（</span><span class=nx>uninstall</span><span class=p>,</span><span class=nx>update</span><span class=err>）</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>install</span> <span class=nx>包名</span> <span class=o>--</span><span class=nx>save</span><span class=o>-</span><span class=nx>dev</span> <span class=p>(</span><span class=nx>uninstall</span><span class=p>,</span><span class=nx>update</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>list</span> <span class=o>-</span><span class=nx>g</span> <span class=p>(</span><span class=nx>不加</span><span class=o>-</span><span class=nx>g</span><span class=err>，</span><span class=nx>列举当前目录下的安装包</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>info</span> <span class=nx>包名</span><span class=err>（</span><span class=nx>详细信息</span><span class=err>）</span> <span class=nx>npm</span> <span class=nx>info</span> <span class=nx>包名</span> <span class=nx>version</span><span class=p>(</span><span class=nx>获取最新版本</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>install</span> <span class=nx>md5</span><span class=err>@</span><span class=mi>1</span><span class=err>（</span><span class=nx>安装指定版本</span><span class=err>）</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>outdated</span><span class=p>(</span>  <span class=nx>检查包是否已经过时</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;dependencies&#34;</span><span class=o>:</span> <span class=p>{</span>    <span class=s2>&#34;md5&#34;</span><span class=o>:</span> <span class=s2>&#34;^2.1.0&#34;</span>  <span class=p>}</span>  <span class=o>^</span> <span class=nx>表示</span> <span class=nx>如果</span> <span class=nx>直接npm</span> <span class=nx>install</span> <span class=nx>将会</span> <span class=nx>安md5</span>
</span></span><span class=line><span class=cl>    <span class=mf>2.</span><span class=o>*</span><span class=p>.</span><span class=o>*</span>  	<span class=nx>最新版本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;dependencies&#34;</span><span class=o>:</span> <span class=p>{</span>    <span class=s2>&#34;md5&#34;</span><span class=o>:</span> <span class=s2>&#34;~2.1.0&#34;</span>  <span class=p>}</span>  <span class=o>~</span> <span class=nx>表示</span> <span class=nx>如果</span> <span class=nx>直接npm</span> <span class=nx>install</span> <span class=nx>将会</span> <span class=nx>安装md5</span> <span class=mf>2.1</span><span class=p>.</span><span class=o>*</span>  <span class=nx>最新版本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;dependencies&#34;</span><span class=o>:</span> <span class=p>{</span>    <span class=s2>&#34;md5&#34;</span><span class=o>:</span> <span class=s2>&#34;*&#34;</span>  <span class=p>}</span>  <span class=o>*</span> <span class=nx>表示</span> <span class=nx>如果</span> <span class=nx>直接npm</span> <span class=nx>install</span> <span class=nx>将会</span> <span class=nx>安装</span> <span class=nx>md5</span>  <span class=nx>最新版本</span>
</span></span></code></pre></div><h6 class="relative group">02 全局安装 nrm<div id=02-%E5%85%A8%E5%B1%80%E5%AE%89%E8%A3%85-nrm class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#02-%E5%85%A8%E5%B1%80%E5%AE%89%E8%A3%85-nrm aria-label=Anchor>#</a></span></h6><blockquote><p>NRM (npm registry manager)是npm的镜像源管理工具，有时候国外资源太慢，使用这个就可以快速地在 npm 源间切换。</p></blockquote><p><code>手动切换方法： npm config set registry https://registry.npm.taobao.org</code></p><p><strong>安装 nrm</strong></p><p>在命令行执行命令，npm install -g nrm，全局安装nrm。</p><p><strong>使用 nrm</strong></p><p>执行命令 nrm ls 查看可选的源。 其中，带*的是当前使用的源，上面的输出表明当前源是官方源。</p><p><strong>切换 nrm</strong></p><p>如果要切换到taobao源，执行命令nrm use taobao。</p><p><strong>测试速度</strong></p><p>你还可以通过 nrm test 测试相应源的响应时间。</p><pre tabindex=0><code>nrm test
</code></pre><blockquote><p>扩展：</p></blockquote><blockquote><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220210114017616.png alt=image-20220210114017616></figure></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npm install -g cnpm --registry<span class=o>=</span>https://registry.npmmirror.com
</span></span></code></pre></div><h6 class="relative group">03 yarn使用<div id=03-yarn%E4%BD%BF%E7%94%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#03-yarn%E4%BD%BF%E7%94%A8 aria-label=Anchor>#</a></span></h6><pre tabindex=0><code>npm install -g yarn
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>对比npm</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=nx>速度超快</span><span class=o>:</span> <span class=nx>Yarn</span> <span class=nx>缓存了每个下载过的包</span><span class=err>，</span><span class=nx>所以再次使用时无需重复下载</span><span class=err>。</span> <span class=nx>同时利用并行下载以最大化资源利用率</span><span class=err>，</span><span class=nx>因此安装速度更快</span><span class=err>。</span>
</span></span><span class=line><span class=cl>    <span class=nx>超级安全</span><span class=o>:</span> <span class=nx>在执行代码之前</span><span class=err>，</span><span class=nx>Yarn</span> <span class=nx>会通过算法校验每个安装包的完整性</span><span class=err>。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>开始新项目</span>
</span></span><span class=line><span class=cl>	<span class=nx>yarn</span> <span class=nx>init</span> 
</span></span><span class=line><span class=cl><span class=nx>添加依赖包</span>
</span></span><span class=line><span class=cl>	<span class=nx>yarn</span> <span class=nx>add</span> <span class=p>[</span><span class=kr>package</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>	<span class=nx>yarn</span> <span class=nx>add</span> <span class=p>[</span><span class=kr>package</span><span class=p>]</span><span class=err>@</span><span class=p>[</span><span class=nx>version</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>	<span class=nx>yarn</span> <span class=nx>add</span> <span class=p>[</span><span class=kr>package</span><span class=p>]</span> <span class=o>--</span><span class=nx>dev</span> 
</span></span><span class=line><span class=cl><span class=nx>升级依赖包</span>
</span></span><span class=line><span class=cl>	 <span class=nx>yarn</span> <span class=nx>upgrade</span> <span class=p>[</span><span class=kr>package</span><span class=p>]</span><span class=err>@</span><span class=p>[</span><span class=nx>version</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=nx>移除依赖包</span>
</span></span><span class=line><span class=cl>	 <span class=nx>yarn</span> <span class=nx>remove</span> <span class=p>[</span><span class=kr>package</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	 
</span></span><span class=line><span class=cl><span class=nx>安装项目的全部依赖</span>
</span></span><span class=line><span class=cl>	 <span class=nx>yarn</span> <span class=nx>install</span> 
</span></span></code></pre></div><h5 class="relative group">5. 内置模块<div id=5--%E5%86%85%E7%BD%AE%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5--%E5%86%85%E7%BD%AE%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h5><h6 class="relative group">01 http模块<div id=01--http%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#01--http%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><blockquote><p>要使用 HTTP 服务器和客户端，则必须 <code>require('http')</code>。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建本地服务器来从其接收数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span> <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=s1>&#39;Hello World!&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>8000</span><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建本地服务器来从其接收数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 监听请求事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;request&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>request</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span> <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=s1>&#39;Hello World!&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>8000</span><span class=p>);</span>
</span></span></code></pre></div><h6 class="relative group">02 url模块<div id=02---url%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#02---url%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><p><strong>02.1 parse</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>urlString</span> <span class=o>=</span> <span class=s1>&#39;https://www.baidu.com:443/ad/index.html?id=8&amp;name=mouse#tag=110&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parsedStr</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>urlString</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>parsedStr</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>02.2 format</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>urlObject</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>protocol</span><span class=o>:</span> <span class=s1>&#39;https:&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>slashes</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>auth</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;www.baidu.com:443&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span><span class=o>:</span> <span class=s1>&#39;443&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hostname</span><span class=o>:</span> <span class=s1>&#39;www.baidu.com&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hash</span><span class=o>:</span> <span class=s1>&#39;#tag=110&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>search</span><span class=o>:</span> <span class=s1>&#39;?id=8&amp;name=mouse&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>query</span><span class=o>:</span> <span class=p>{</span> <span class=nx>id</span><span class=o>:</span> <span class=s1>&#39;8&#39;</span><span class=p>,</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;mouse&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pathname</span><span class=o>:</span> <span class=s1>&#39;/ad/index.html&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/ad/index.html?id=8&amp;name=mouse&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>parsedObj</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=nx>urlObject</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>parsedObj</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>02.3 resolve</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=s1>&#39;/one/two/three&#39;</span><span class=p>,</span> <span class=s1>&#39;four&#39;</span><span class=p>)</span>  <span class=p>(</span> <span class=nx>注意最后加</span><span class=o>/</span> <span class=err>，</span><span class=nx>不加</span><span class=o>/</span><span class=nx>的区别</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=s1>&#39;http://example.com/&#39;</span><span class=p>,</span> <span class=s1>&#39;/one&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>c</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=s1>&#39;http://example.com/one&#39;</span><span class=p>,</span> <span class=s1>&#39;/two&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>a</span> <span class=o>+</span> <span class=s2>&#34;,&#34;</span> <span class=o>+</span> <span class=nx>b</span> <span class=o>+</span> <span class=s2>&#34;,&#34;</span> <span class=o>+</span> <span class=nx>c</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">03 querystring模块<div id=03--querystring%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#03--querystring%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><p><strong>03.1 parse</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>qs</span> <span class=o>=</span> <span class=s1>&#39;x=3&amp;y=4&#39;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>parsed</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>qs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>parsed</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>03.2 stringify</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>qo</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>x</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>y</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>parsed</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>qo</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>parsed</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>03.3 escape/unescape</strong></p><img src=nodejs速览笔记.assets/image-20220213211406894.png alt=image-20220213211406894 style=zoom:67%>
<img src=nodejs速览笔记.assets/image-20220213211423142.png alt=image-20220213211423142 style=zoom:67%><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>str</span> <span class=o>=</span> <span class=s1>&#39;id=3&amp;city=北京&amp;url=https://www.baidu.com&#39;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>escaped</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>escape</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>escaped</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>str</span> <span class=o>=</span> <span class=s1>&#39;id%3D3%26city%3D%E5%8C%97%E4%BA%AC%26url%3Dhttps%3A%2F%2Fwww.baidu.com&#39;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>unescaped</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>unescape</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>unescaped</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">04 http模块补充<div id=04--http%E6%A8%A1%E5%9D%97%E8%A1%A5%E5%85%85 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#04--http%E6%A8%A1%E5%9D%97%E8%A1%A5%E5%85%85 aria-label=Anchor>#</a></span></h6><p><strong>04.1 接口：jsonp</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>urlObj</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nx>urlObj</span><span class=p>.</span><span class=nx>pathname</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;/api/user&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>urlObj</span><span class=p>.</span><span class=nx>query</span><span class=p>.</span><span class=nx>cb</span><span class=si>}</span><span class=sb>({&#34;name&#34;: &#34;gp145&#34;})`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;404.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>8080</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;localhost:8080&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p><strong>04.2 跨域：CORS</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>data</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>urlObj</span> <span class=o>=</span> <span class=nx>url</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;content-type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json;charset=utf-8&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Access-Control-Allow-Origin&#39;</span><span class=o>:</span> <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>+=</span> <span class=nx>chunk</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>responseResult</span><span class=p>(</span><span class=nx>querystring</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>responseResult</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>urlObj</span><span class=p>.</span><span class=nx>pathname</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;/api/login&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>message</span><span class=o>:</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>        <span class=p>}))</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s1>&#39;404.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>8080</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;localhost:8080&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p><strong>04.3 模拟get</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>https</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;https&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 1、接口 2、跨域
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>.</span><span class=nx>substr</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>response</span><span class=p>.</span><span class=nx>writeHeader</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;content-type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json;charset=utf-8&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Access-Control-Allow-Origin&#39;</span><span class=o>:</span> <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>https</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`https://m.lagou.com/listmore.json</span><span class=si>${</span><span class=nx>url</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span> <span class=o>+=</span> <span class=nx>chunk</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>ret</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>8080</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;localhost:8080&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p><strong>04.4 模拟post：服务器提交（攻击）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>https</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;https&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>postData</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>province</span><span class=o>:</span> <span class=s1>&#39;上海&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>city</span><span class=o>:</span> <span class=s1>&#39;上海&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>district</span><span class=o>:</span> <span class=s1>&#39;宝山区&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>address</span><span class=o>:</span> <span class=s1>&#39;同济支路199号智慧七立方3号楼2-4层&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>latitude</span><span class=o>:</span> <span class=mf>43.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>longitude</span><span class=o>:</span> <span class=mf>160.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;求购一条小鱼&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>contact</span><span class=o>:</span> <span class=s1>&#39;13666666&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;sell&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>time</span><span class=o>:</span> <span class=mi>1571217561</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>protocol</span><span class=o>:</span> <span class=s1>&#39;https:&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hostname</span><span class=o>:</span> <span class=s1>&#39;ik9hkddr.qcloud.la&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>method</span><span class=o>:</span> <span class=s1>&#39;POST&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span><span class=o>:</span> <span class=mi>443</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/index.php/trade/add_item&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/x-www-form-urlencoded&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>byteLength</span><span class=p>(</span><span class=nx>postData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>doPost</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>req</span> <span class=o>=</span> <span class=nx>https</span><span class=p>.</span><span class=nx>request</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=nx>chunk</span> <span class=p>=&gt;</span> <span class=nx>data</span> <span class=o>+=</span> <span class=nx>chunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>req</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>postData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>req</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// setInterval(() =&gt; {
</span></span></span><span class=line><span class=cl><span class=c1>//   doPost()
</span></span></span><span class=line><span class=cl><span class=c1>// }, 1000)
</span></span></span></code></pre></div><p><strong>04.5 爬虫</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>https</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;https&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>cheerio</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;cheerio&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>response</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;content-type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json;charset=utf-8&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// protocol: &#39;https:&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>hostname</span><span class=o>:</span> <span class=s1>&#39;i.maoyan.com&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>port</span><span class=o>:</span> <span class=mi>443</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>method</span><span class=o>:</span> <span class=s1>&#39;GET&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>req</span> <span class=o>=</span> <span class=nx>https</span><span class=p>.</span><span class=nx>request</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>data</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span> <span class=o>+=</span> <span class=nx>chunk</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>filterData</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>filterData</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//   console.log(data)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>$</span> <span class=o>=</span> <span class=nx>cheerio</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>$movieList</span> <span class=o>=</span> <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;.column.content&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>$movieList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>movies</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=nx>$movieList</span><span class=p>.</span><span class=nx>each</span><span class=p>((</span><span class=nx>index</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>movies</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=nx>$</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>find</span><span class=p>(</span><span class=s1>&#39;.movie-title .title&#39;</span><span class=p>).</span><span class=nx>text</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>detail</span><span class=o>:</span> <span class=nx>$</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>find</span><span class=p>(</span><span class=s1>&#39;.detail .actor&#39;</span><span class=p>).</span><span class=nx>text</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>movies</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>req</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">05 event模块<div id=05--event%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#05--event%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>EventEmitter</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;events&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>MyEventEmitter</span> <span class=kr>extends</span> <span class=nx>EventEmitter</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>event</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MyEventEmitter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>event</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;play&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>movie</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>movie</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>event</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;play&#39;</span><span class=p>,</span> <span class=s1>&#39;我和我的祖国&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>event</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;play&#39;</span><span class=p>,</span> <span class=s1>&#39;中国机长&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">06 fs文件操作模块<div id=06--fs%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#06--fs%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 创建文件夹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>mkdir</span><span class=p>(</span><span class=s1>&#39;./logs&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;done.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 文件夹改名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>rename</span><span class=p>(</span><span class=s1>&#39;./logs&#39;</span><span class=p>,</span> <span class=s1>&#39;./log&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;done&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除文件夹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>rmdir</span><span class=p>(</span><span class=s1>&#39;./log&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;done.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 写内容到文件里
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>writeFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;./logs/log1.txt&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;hello&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 错误优先的回调函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;文件创建成功&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 给文件追加内容
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>appendFile</span><span class=p>(</span><span class=s1>&#39;./logs/log1.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;\nworld&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;done.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读取文件内容
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;./logs/log1.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>unlink</span><span class=p>(</span><span class=s1>&#39;./logs/log1.txt&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;done.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 批量写文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>fs</span><span class=p>.</span><span class=nx>writeFile</span><span class=p>(</span><span class=sb>`./logs/log-</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>.txt`</span><span class=p>,</span> <span class=sb>`log-</span><span class=si>${</span><span class=nx>i</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;done.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读取文件/目录信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>readdir</span><span class=p>(</span><span class=s1>&#39;./&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>value</span><span class=p>,</span> <span class=nx>index</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fs</span><span class=p>.</span><span class=nx>stat</span><span class=p>(</span><span class=sb>`./</span><span class=si>${</span><span class=nx>value</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>stats</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// console.log(value + &#39;:&#39; + stats.size)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>value</span> <span class=o>+</span> <span class=s1>&#39; is &#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>stats</span><span class=p>.</span><span class=nx>isDirectory</span><span class=p>()</span> <span class=o>?</span> <span class=s1>&#39;directory&#39;</span> <span class=o>:</span> <span class=s1>&#39;file&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 同步读取文件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>content</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;./logs/log-1.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 异步读取文件：方法一
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;./logs/log-0.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>content</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 异步读取文件：方法二
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;fs&#34;</span><span class=p>).</span><span class=nx>promises</span>
</span></span><span class=line><span class=cl><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;./logs/log-0.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>result</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>在<code>fs</code>模块中，提供同步方法是为了方便使用。那我们到底是应该用异步方法还是同步方法呢？</p><p>由于Node环境执行的JavaScript代码是服务器端代码，所以，绝大部分需要在服务器运行期反复执行业务逻辑的代码，<em>必须使用异步代码</em>，否则，同步代码在执行时期，服务器将停止响应，因为JavaScript只有一个执行线程。</p><p>服务器启动时如果需要读取配置文件，或者结束时需要写入到状态文件时，可以使用同步代码，因为这些代码只在启动和结束时执行一次，不影响服务器正常运行时的异步执行。</p><h6 class="relative group">07 stream流模块<div id=07--stream%E6%B5%81%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#07--stream%E6%B5%81%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><p><code>stream</code>是Node.js提供的又一个仅在服务区端可用的模块，目的是支持“流”这种数据结构。</p><p>什么是流？流是一种抽象的数据结构。想象水流，当在水管中流动时，就可以从某个地方（例如自来水厂）源源不断地到达另一个地方（比如你家的洗手池）。我们也可以把数据看成是数据流，比如你敲键盘的时候，就可以把每个字符依次连起来，看成字符流。这个流是从键盘输入到应用程序，实际上它还对应着一个名字：标准输入流（stdin）。</p><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220407085931744.png alt=image-20220407085931744></figure></p><p>如果应用程序把字符一个一个输出到显示器上，这也可以看成是一个流，这个流也有名字：标准输出流（stdout）。流的特点是数据是有序的，而且必须依次读取，或者依次写入，不能像Array那样随机定位。</p><p>有些流用来读取数据，比如从文件读取数据时，可以打开一个文件流，然后从文件流中不断地读取数据。有些流用来写入数据，比如向文件写入数据时，只需要把数据不断地往文件流中写进去就可以了。</p><p>在Node.js中，流也是一个对象，我们只需要响应流的事件就可以了：<code>data</code>事件表示流的数据已经可以读取了，<code>end</code>事件表示这个流已经到末尾了，没有数据可以读取了，<code>error</code>事件表示出错了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 打开一个流:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>rs</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=s1>&#39;sample.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rs</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;DATA:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rs</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;END&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>rs</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;ERROR: &#39;</span> <span class=o>+</span> <span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>要注意，<code>data</code>事件可能会有多次，每次传递的<code>chunk</code>是流的一部分数据。</p><p>要以流的形式写入文件，只需要不断调用<code>write()</code>方法，最后以<code>end()</code>结束：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ws1</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;output1.txt&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>ws1</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s1>&#39;使用Stream写入文本数据...\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>ws1</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s1>&#39;END.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>ws1</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span></code></pre></div><p><code>pipe</code> 就像可以把两个水管串成一个更长的水管一样，两个流也可以串起来。一个<code>Readable</code>流和一个<code>Writable</code>流串起来后，所有的数据自动从<code>Readable</code>流进入<code>Writable</code>流，这种操作叫<code>pipe</code>。</p><p>在Node.js中，<code>Readable</code>流有一个<code>pipe()</code>方法，就是用来干这件事的。</p><p>让我们用<code>pipe()</code>把一个文件流和另一个文件流串起来，这样源文件的所有数据就自动写入到目标文件里了，所以，这实际上是一个复制文件的程序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>readstream</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=s1>&#39;./1.txt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>writestream</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;./2.txt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>readstream</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>writestream</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">08 zlib<div id=08-zlib class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#08-zlib aria-label=Anchor>#</a></span></h6><img src=nodejs速览笔记.assets/image-20220407105916114.png alt=image-20220407105916114 style=zoom:50%><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>zlib</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;zlib&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>gzip</span> <span class=o>=</span> <span class=nx>zlib</span><span class=p>.</span><span class=nx>createGzip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>readstream</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=s1>&#39;./note.txt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>writestream</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createWriteStream</span><span class=p>(</span><span class=s1>&#39;./note2.txt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>readstream</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>gzip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>writestream</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">09 crypto<div id=09-crypto class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#09-crypto aria-label=Anchor>#</a></span></h6><p>crypto模块的目的是为了提供通用的加密和哈希算法。用纯JavaScript代码实现这些功能不是不可能，但速度会非常慢。Nodejs用C/C++实现这些算法后，通过cypto这个模块暴露为JavaScript接口，这样用起来方便，运行速度也快。</p><p>MD5是一种常用的哈希算法，用于给任意数据一个“签名”。这个签名通常用一个十六进制的字符串表示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>crypto</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;crypto&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>hash</span> <span class=o>=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>createHash</span><span class=p>(</span><span class=s1>&#39;md5&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 可任意多次调用update():
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>hash</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=s1>&#39;Hello, world!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>hash</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=s1>&#39;Hello, nodejs!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>hash</span><span class=p>.</span><span class=nx>digest</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>));</span> 
</span></span></code></pre></div><p><code>update()</code>方法默认字符串编码为<code>UTF-8</code>，也可以传入Buffer。</p><p>如果要计算SHA1，只需要把<code>'md5'</code>改成<code>'sha1'</code>，就可以得到SHA1的结果<code>1f32b9c9932c02227819a4151feed43e131aca40</code>。</p><p>Hmac算法也是一种哈希算法，它可以利用MD5或SHA1等哈希算法。不同的是，Hmac还需要一个密钥：</p><pre tabindex=0><code>const crypto = require(&#39;crypto&#39;);

const hmac = crypto.createHmac(&#39;sha256&#39;, &#39;secret-key&#39;);

hmac.update(&#39;Hello, world!&#39;);
hmac.update(&#39;Hello, nodejs!&#39;);

console.log(hmac.digest(&#39;hex&#39;)); // 80f7e22570...
</code></pre><p>只要密钥发生了变化，那么同样的输入数据也会得到不同的签名，因此，可以把Hmac理解为用随机数“增强”的哈希算法。</p><p>AES是一种常用的对称加密算法，加解密都用同一个密钥。crypto模块提供了AES支持，但是需要自己封装好函数，便于使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>crypto</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;crypto&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>encrypt</span> <span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>iv</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>decipher</span> <span class=o>=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>createCipheriv</span><span class=p>(</span><span class=s1>&#39;aes-128-cbc&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>iv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// decipher.setAutoPadding(true);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>decipher</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=s1>&#39;binary&#39;</span><span class=p>,</span> <span class=s1>&#39;hex&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=nx>decipher</span><span class=p>.</span><span class=kr>final</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>decrypt</span> <span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>iv</span><span class=p>,</span> <span class=nx>crypted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nx>crypted</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>crypted</span><span class=p>,</span> <span class=s1>&#39;hex&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;binary&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>     <span class=kd>let</span> <span class=nx>decipher</span> <span class=o>=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nx>createDecipheriv</span><span class=p>(</span><span class=s1>&#39;aes-128-cbc&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>iv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>     <span class=k>return</span> <span class=nx>decipher</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>crypted</span><span class=p>,</span> <span class=s1>&#39;binary&#39;</span><span class=p>,</span> <span class=s1>&#39;utf8&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=nx>decipher</span><span class=p>.</span><span class=kr>final</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>key</span><span class=p>,</span><span class=nx>iv必须是16个字节</span>
</span></span></code></pre></div><p>可以看出，加密后的字符串通过解密又得到了原始内容。</p><h5 class="relative group">6. 路由<div id=6---%E8%B7%AF%E7%94%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6---%E8%B7%AF%E7%94%B1 aria-label=Anchor>#</a></span></h5><h6 class="relative group">01 基础<div id=01---%E5%9F%BA%E7%A1%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#01---%E5%9F%BA%E7%A1%80 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * @作者: kerwin
</span></span></span><span class=line><span class=cl><span class=cm> * @公众号: 大前端私房菜
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;fs&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;path&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>render</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span> <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/html;charset=utf8&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>route</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/login&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>render</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=s2>&#34;./static/login.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/home&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>render</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=s2>&#34;./static/home.html&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/404&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>404</span><span class=p>,</span> <span class=p>{</span> <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/html;charset=utf8&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s2>&#34;./static/404.html&#34;</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h6 class="relative group">02 获取参数<div id=02---%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#02---%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0 aria-label=Anchor>#</a></span></h6><p>get请求</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=s2>&#34;/api/login&#34;</span><span class=o>:</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>myURL</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s1>&#39;http://127.0.0.1:3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>myURL</span><span class=p>.</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>))</span>   
</span></span><span class=line><span class=cl>        <span class=nx>render</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span><span class=sb>`{ok:1}`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>post请求</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;/api/login&#34;</span><span class=o>:</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>post</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过req的data事件监听函数，每当接受到请求体的数据，就累加到post变量中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>post</span> <span class=o>+=</span> <span class=nx>chunk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 在end事件触发后，通过querystring.parse将post解析为真正的POST请求格式，然后向客户端返回。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>post</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>post</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>render</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=sb>`{ok:1}`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><h6 class="relative group">03 静态资源处理<div id=03---%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#03---%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>readStaticFile</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>myURL</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s1>&#39;http://127.0.0.1:3000&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>filePathname</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span> <span class=s2>&#34;/static&#34;</span><span class=p>,</span> <span class=nx>myURL</span><span class=p>.</span><span class=nx>pathname</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>existsSync</span><span class=p>(</span><span class=nx>filePathname</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// console.log(1111)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span> <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=sb>`</span><span class=si>${</span><span class=nx>mime</span><span class=p>.</span><span class=nx>getType</span><span class=p>(</span><span class=nx>myURL</span><span class=p>.</span><span class=nx>pathname</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span><span class=si>}</span><span class=sb>;charset=utf8`</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=nx>filePathname</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">二、Express<div id=%E4%BA%8Cexpress class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BA%8Cexpress aria-label=Anchor>#</a></span></h4><blockquote><p><a href=https://www.expressjs.com.cn/ target=_blank>https://www.expressjs.com.cn/</a></p></blockquote><p>基于 Node.js 平台，快速、开放、极简的 web 开发框架。</p><h5 class="relative group">1.特色<div id=1%E7%89%B9%E8%89%B2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E7%89%B9%E8%89%B2 aria-label=Anchor>#</a></span></h5><img src=nodejs速览笔记.assets/image-20220411103139587.png alt=image-20220411103139587 style=zoom:50%;float:left><h5 class="relative group">2.安装<div id=2%E5%AE%89%E8%A3%85 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2%E5%AE%89%E8%A3%85 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>$</span> <span class=nx>npm</span> <span class=nx>install</span> <span class=nx>express</span> <span class=o>--</span><span class=nx>save</span>
</span></span></code></pre></div><h5 class="relative group">3.路由<div id=3%E8%B7%AF%E7%94%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3%E8%B7%AF%E7%94%B1 aria-label=Anchor>#</a></span></h5><p>路由是指如何定义应用的端点（URIs）以及如何响应客户端的请求。</p><p>路由是由一个 URI、HTTP 请求（GET、POST等）和若干个句柄组成，它的结构如下： app.METHOD(path, [callback&mldr;], callback)， app 是 express 对象的一个实例， METHOD 是一个 HTTP 请求方法， path 是服务器上的路径， callback 是当路由匹配时要执行的函数。</p><p>下面是一个基本的路由示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// respond with &#34;hello world&#34; when a GET request is made to the homepage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;hello world&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>路由路径和请求方法一起定义了请求的端点，它可以是字符串、字符串模式或者正则表达式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 匹配根路径的请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;root&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 /about 路径的请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/about&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;about&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 /random.text 路径的请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/random.text&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;random.text&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>使用字符串模式的路由路径示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 匹配 acd 和 abcd
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/ab?cd&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;ab?cd&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 /ab/******
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/ab/:id&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;aaaaaaa&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 abcd、abbcd、abbbcd等
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/ab+cd&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;ab+cd&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 abcd、abxcd、abRABDOMcd、ab123cd等
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/ab*cd&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;ab*cd&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 /abe 和 /abcde
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/ab(cd)?e&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;ab(cd)?e&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>使用正则表达式的路由路径示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 匹配任何路径中含有 a 的路径：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sr>/a/</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;/a/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 匹配 butterfly、dragonfly，不匹配 butterflyman、dragonfly man等
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sr>/.*fly$/</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;/.*fly$/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>可以为请求处理提供多个回调函数，其行为类似 中间件。唯一的区别是这些回调函数有可能调用 next(&lsquo;route&rsquo;) 方法而略过其他路由回调函数。可以利用该机制为路由定义前提条件，如果在现有路径上继续执行没有意义，则可将控制权交给剩下的路径。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/example/a&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Hello from A!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>使用多个回调函数处理路由（记得指定 next 对象）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/example/b&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;response will be sent by the next function ...&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Hello from B!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>使用回调函数数组处理路由：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cb0</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;CB0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cb1</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;CB1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cb2</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Hello from C!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/example/c&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>cb0</span><span class=p>,</span> <span class=nx>cb1</span><span class=p>,</span> <span class=nx>cb2</span><span class=p>])</span>
</span></span></code></pre></div><p>混合使用函数和函数数组处理路由：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cb0</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;CB0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cb1</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;CB1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/example/d&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>cb0</span><span class=p>,</span> <span class=nx>cb1</span><span class=p>],</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;response will be sent by the next function ...&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Hello from D!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h5 class="relative group">4.中间件<div id=4%E4%B8%AD%E9%97%B4%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4%E4%B8%AD%E9%97%B4%E4%BB%B6 aria-label=Anchor>#</a></span></h5><p>Express 是一个自身功能极简，完全是由路由和中间件构成一个的 web 开发框架：从本质上来说，一个 Express 应用就是在调用各种中间件。</p><p>中间件（Middleware） 是一个函数，它可以访问请求对象（request object (req)）, 响应对象（response object (res)）, 和 web 应用中处于请求-响应循环流程中的中间件，一般被命名为 next 的变量。</p><p>中间件的功能包括：</p><ul><li>执行任何代码。</li><li>修改请求和响应对象。</li><li>终结请求-响应循环。</li><li>调用堆栈中的下一个中间件。</li></ul><p>如果当前中间件没有终结请求-响应循环，则必须调用 next() 方法将控制权交给下一个中间件，否则请求就会挂起。</p><p>Express 应用可使用如下几种中间件：</p><ul><li>应用级中间件</li><li>路由级中间件</li><li>错误处理中间件</li><li>内置中间件</li><li>第三方中间件</li></ul><p>使用可选则挂载路径，可在应用级别或路由级别装载中间件。另外，你还可以同时装在一系列中间件函数，从而在一个挂载点上创建一个子中间件栈。</p><h6 class="relative group">（1）应用级中间件<div id=1%E5%BA%94%E7%94%A8%E7%BA%A7%E4%B8%AD%E9%97%B4%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E5%BA%94%E7%94%A8%E7%BA%A7%E4%B8%AD%E9%97%B4%E4%BB%B6 aria-label=Anchor>#</a></span></h6><p>应用级中间件绑定到 app 对象 使用 app.use() 和 app.METHOD()， 其中， METHOD 是需要处理的 HTTP 请求的方法，例如 GET, PUT, POST 等等，全部小写。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 没有挂载路径的中间件，应用的每个请求都会执行该中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Time:&#39;</span><span class=p>,</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h6 class="relative group">（2）路由级中间件<div id=2%E8%B7%AF%E7%94%B1%E7%BA%A7%E4%B8%AD%E9%97%B4%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2%E8%B7%AF%E7%94%B1%E7%BA%A7%E4%B8%AD%E9%97%B4%E4%BB%B6 aria-label=Anchor>#</a></span></h6><p>路由级中间件和应用级中间件一样，只是它绑定的对象为 express.Router()。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 没有挂载路径的中间件，通过该路由的每个请求都会执行该中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Time:&#39;</span><span class=p>,</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 一个中间件栈，显示任何指向 /user/:id 的 HTTP 请求的信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/user/:id&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Request URL:&#39;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>originalUrl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Request Type:&#39;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 一个中间件栈，处理指向 /user/:id 的 GET 请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/user/:id&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果 user id 为 0, 跳到下一个路由
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=nx>next</span><span class=p>(</span><span class=s1>&#39;route&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 负责将控制权交给栈中下一个中间件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span> <span class=nx>next</span><span class=p>()</span> <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 渲染常规页面
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;regular&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 处理 /user/:id， 渲染一个特殊页面
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/user/:id&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;special&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 将路由挂载至应用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>router</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">（3）错误处理中间件<div id=3%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%AD%E9%97%B4%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%AD%E9%97%B4%E4%BB%B6 aria-label=Anchor>#</a></span></h6><p>错误处理中间件和其他中间件定义类似，只是要使用 4 个参数，而不是 3 个，其签名如下： (err, req, res, next)。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>stack</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;Something broke!&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h6 class="relative group">（4）内置的中间件<div id=4%E5%86%85%E7%BD%AE%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4%E5%86%85%E7%BD%AE%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6 aria-label=Anchor>#</a></span></h6><p>express.static 是 Express 唯一内置的中间件。它基于 serve-static，负责在 Express 应用中提托管静态资源。每个应用可有多个静态目录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=s1>&#39;public&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=s1>&#39;uploads&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=s1>&#39;files&#39;</span><span class=p>))</span>
</span></span></code></pre></div><h6 class="relative group">（5）第三方中间件<div id=5%E7%AC%AC%E4%B8%89%E6%96%B9%E4%B8%AD%E9%97%B4%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5%E7%AC%AC%E4%B8%89%E6%96%B9%E4%B8%AD%E9%97%B4%E4%BB%B6 aria-label=Anchor>#</a></span></h6><p>安装所需功能的 node 模块，并在应用中加载，可以在应用级加载，也可以在路由级加载。</p><p>下面的例子安装并加载了一个解析 cookie 的中间件： cookie-parser</p><pre tabindex=0><code>$ npm install cookie-parser
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cookieParser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;cookie-parser&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 加载用于解析 cookie 的中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>())</span>
</span></span></code></pre></div><h5 class="relative group">5. 获取请求参数<div id=5-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0 aria-label=Anchor>#</a></span></h5><p>get</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>req</span><span class=p>.</span><span class=nx>query</span>
</span></span></code></pre></div><p>post</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span><span class=nx>extended</span><span class=o>:</span><span class=kc>false</span><span class=p>}))</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>req</span><span class=p>.</span><span class=nx>body</span>
</span></span></code></pre></div><h5 class="relative group">6.利用 Express 托管静态文件<div id=6%E5%88%A9%E7%94%A8-express-%E6%89%98%E7%AE%A1%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6%E5%88%A9%E7%94%A8-express-%E6%89%98%E7%AE%A1%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6 aria-label=Anchor>#</a></span></h5><p>通过 Express 内置的 express.static 可以方便地托管静态文件，例如图片、CSS、JavaScript 文件等。</p><p>将静态资源文件所在的目录作为参数传递给 express.static 中间件就可以提供静态资源文件的访问了。例如，假设在 public 目录放置了图片、CSS 和 JavaScript 文件，你就可以：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=s1>&#39;public&#39;</span><span class=p>))</span>
</span></span></code></pre></div><p>现在，public 目录下面的文件就可以访问了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/images/kitten.jpg
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/css/style.css
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/js/app.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/images/bg.png
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/hello.html
</span></span></span></code></pre></div><blockquote><p>所有文件的路径都是相对于存放目录的，因此，存放静态文件的目录名不会出现在 URL 中。</p></blockquote><p>如果你的静态资源存放在多个目录下面，你可以多次调用 express.static 中间件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=s1>&#39;public&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=s1>&#39;files&#39;</span><span class=p>))</span>
</span></span></code></pre></div><p>访问静态资源文件时，express.static 中间件会根据目录添加的顺序查找所需的文件。</p><p>如果你希望所有通过 express.static 访问的文件都存放在一个“虚拟（virtual）”目录（即目录根本不存在）下面，可以通过为静态资源目录指定一个挂载路径的方式来实现，如下所示：</p><pre tabindex=0><code>app.use(&#39;/static&#39;, express.static(&#39;public&#39;))
</code></pre><p>现在，你就可以通过带有 “/static” 前缀的地址来访问 public 目录下面的文件了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/static/images/kitten.jpg
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/static/css/style.css
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/static/js/app.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/static/images/bg.png
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000/static/hello.html
</span></span></span></code></pre></div><h5 class="relative group">7.服务端渲染（模板引擎）<div id=7%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#7%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E aria-label=Anchor>#</a></span></h5><img src=nodejs速览笔记.assets/image-20220411104609389.png alt=image-20220411104609389 style=zoom:50%;float:left><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>i</span> <span class=nx>ejs</span>
</span></span></code></pre></div><p>需要在应用中进行如下设置才能让 Express 渲染模板文件：</p><ul><li>views, 放模板文件的目录，比如： app.set(&lsquo;views&rsquo;, &lsquo;./views&rsquo;)</li><li>view engine, 模板引擎，比如： app.set(&lsquo;view engine&rsquo;, &rsquo;ejs&rsquo;)</li></ul><img src=nodejs速览笔记.assets/image-20220411104652068.png alt=image-20220411104652068 style=zoom:50%;float:left><h4 class="relative group">三、MongoDB<div id=%E4%B8%89mongodb class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%B8%89mongodb aria-label=Anchor>#</a></span></h4><h5 class="relative group">1.关系型与非关系型数据库<div id=1%E5%85%B3%E7%B3%BB%E5%9E%8B%E4%B8%8E%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E5%85%B3%E7%B3%BB%E5%9E%8B%E4%B8%8E%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93 aria-label=Anchor>#</a></span></h5><img src=nodejs速览笔记.assets/image-20220413085332378.png alt=image-20220413085332378 style=zoom:67%;float:left>
<img src=nodejs速览笔记.assets/image-20220413090707891.png alt=image-20220413090707891 style=zoom:67%;float:left><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220413090406721.png alt=image-20220413090406721></figure></p><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220413090614205.png alt=image-20220413090614205></figure></p><h5 class="relative group">2.安装数据库<div id=2%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93 aria-label=Anchor>#</a></span></h5><p><a href=https://docs.mongodb.com/manual/administration/install-community/ target=_blank>https://docs.mongodb.com/manual/administration/install-community/</a></p><h5 class="relative group">3.启动数据库<div id=3%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%BA%93 aria-label=Anchor>#</a></span></h5><h6 class="relative group">（1）windows<div id=1windows class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1windows aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-s data-lang=s><span class=line><span class=cl><span class=n>mongod</span> <span class=o>--</span><span class=n>dbpath</span> <span class=n>d</span><span class=o>:/</span><span class=n>data</span><span class=o>/</span><span class=n>db</span>
</span></span><span class=line><span class=cl><span class=n>mongo</span>
</span></span></code></pre></div><h6 class="relative group">（2）mac<div id=2mac class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2mac aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-s data-lang=s><span class=line><span class=cl><span class=n>mongod</span> <span class=o>--</span><span class=n>config</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>local</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>mongod.conf</span>
</span></span><span class=line><span class=cl><span class=n>mongo</span>
</span></span></code></pre></div><h5 class="relative group">4.在命令行中操作数据库<div id=4%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4%E5%9C%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93 aria-label=Anchor>#</a></span></h5><img src=nodejs速览笔记.assets/image-20220413090814836.png alt=image-20220413090814836 style=zoom:50%;float:left>
<img src=nodejs速览笔记.assets/image-20220413090825381.png alt=image-20220413090825381 style=zoom:50%;float:left>
<img src=nodejs速览笔记.assets/image-20220413090837613.png alt=image-20220413090837613 style=zoom:50%;float:left>
<img src=nodejs速览笔记.assets/image-20220413090858199.png alt=image-20220413090858199 style=zoom:50%;float:left>
<img src=nodejs速览笔记.assets/image-20220413090907539.png alt=image-20220413090907539 style=zoom:50%;float:left>
<img src=nodejs速览笔记.assets/image-20220413090916971.png alt=image-20220413090916971 style=zoom:50%;float:left><h5 class="relative group">5.可视化工具进行增删改查<div id=5%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5 aria-label=Anchor>#</a></span></h5><p>Robomongo Robo3T adminMongo</p><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220413091031852.png alt=image-20220413091031852></figure></p><h5 class="relative group">6.nodejs连接操作数据库<div id=6nodejs%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6nodejs%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93 aria-label=Anchor>#</a></span></h5><p>连接数据库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mongoose</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;mongoose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mongoose</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=s2>&#34;mongodb://127.0.0.1:27017/company-system&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>创建模型</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mongoose</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;mongoose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Schema</span> <span class=o>=</span> <span class=nx>mongoose</span><span class=p>.</span><span class=nx>Schema</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>gender</span><span class=o>:</span><span class=nb>Number</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>introduction</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>avatar</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span><span class=nb>Number</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserModel</span> <span class=o>=</span> <span class=nx>mongoose</span><span class=p>.</span><span class=nx>model</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span><span class=k>new</span> <span class=nx>Schema</span><span class=p>(</span><span class=nx>UserType</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span>  <span class=o>=</span> <span class=nx>UserModel</span> 
</span></span></code></pre></div><p>增加数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>UserModel</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>introduction</span><span class=p>,</span><span class=nx>username</span><span class=p>,</span><span class=nx>gender</span><span class=p>,</span><span class=nx>avatar</span><span class=p>,</span><span class=nx>password</span><span class=p>,</span><span class=nx>role</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>查询数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>UserModel</span><span class=p>.</span><span class=nx>find</span><span class=p>({</span><span class=nx>username</span><span class=o>:</span><span class=s2>&#34;kerwin&#34;</span><span class=p>},[</span><span class=s2>&#34;username&#34;</span><span class=p>,</span><span class=s2>&#34;role&#34;</span><span class=p>,</span><span class=s2>&#34;introduction&#34;</span><span class=p>,</span><span class=s2>&#34;password&#34;</span><span class=p>]).</span><span class=nx>sort</span><span class=p>({</span><span class=nx>createTime</span><span class=o>:-</span><span class=mi>1</span><span class=p>}).</span><span class=nx>skip</span><span class=p>(</span><span class=mi>10</span><span class=p>).</span><span class=nx>limit</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span></code></pre></div><p>更新数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>UserModel</span><span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>_id</span>
</span></span><span class=line><span class=cl><span class=p>},{</span>
</span></span><span class=line><span class=cl>    <span class=nx>introduction</span><span class=p>,</span><span class=nx>username</span><span class=p>,</span><span class=nx>gender</span><span class=p>,</span><span class=nx>avatar</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p>删除数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>UserModel</span><span class=p>.</span><span class=nx>deleteOne</span><span class=p>({</span><span class=nx>_id</span><span class=p>})</span>
</span></span></code></pre></div><h4 class="relative group">四、接口规范与业务分层<div id=%E5%9B%9B%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%E4%B8%8E%E4%B8%9A%E5%8A%A1%E5%88%86%E5%B1%82 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%9B%9B%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%E4%B8%8E%E4%B8%9A%E5%8A%A1%E5%88%86%E5%B1%82 aria-label=Anchor>#</a></span></h4><h5 class="relative group">1.接口规范<div id=1%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83 aria-label=Anchor>#</a></span></h5><img src=nodejs速览笔记.assets/image-20220414094020921.png alt=image-20220414094020921 style=zoom:67%;float:left>
<img src=nodejs速览笔记.assets/image-20220414094043782.png alt=image-20220414094043782 style=zoom:67%;float:left><h5 class="relative group">2.业务分层<div id=2%E4%B8%9A%E5%8A%A1%E5%88%86%E5%B1%82 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2%E4%B8%9A%E5%8A%A1%E5%88%86%E5%B1%82 aria-label=Anchor>#</a></span></h5><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220414094653807.png alt=image-20220414094653807></figure></p><h4 class="relative group">五、登录鉴权<div id=%E4%BA%94%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%BA%94%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83 aria-label=Anchor>#</a></span></h4><h5 class="relative group">1. Cookie&amp;Session<div id=1-cookiesession class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-cookiesession aria-label=Anchor>#</a></span></h5><p>「HTTP 无状态」<strong>我们知道，HTTP 是无状态的。也就是说，HTTP 请求方和响应方间无法维护状态，都是一次性的，它不知道前后的请求都发生了什么。但有的场景下，我们需要维护状态。最典型的，一个用户登陆微博，发布、关注、评论，都应是在登录后的用户状态下的。</strong>「标记」那解决办法是什么呢？<figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220414095345868.png alt=image-20220414095345868></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;express&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;express-session&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>MongoStore</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;connect-mongo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>secret</span><span class=o>:</span> <span class=s2>&#34;this is session&#34;</span><span class=p>,</span> <span class=c1>// 服务器生成 session 的签名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>resave</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=nx>saveUninitialized</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>//强制将为初始化的 session 存储
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cookie</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>maxAge</span><span class=o>:</span> <span class=mi>1000</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>10</span><span class=p>,</span><span class=c1>// 过期时间
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>secure</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=c1>// 为 true 时候表示只有 https 协议才能访问cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>rolling</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>//为 true 表示 超时前刷新，cookie 会重新计时； 为 false 表示在超时前刷新多少次，都是按照第一次刷新开始计时。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>store</span><span class=o>:</span> <span class=nx>MongoStore</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>mongoUrl</span><span class=o>:</span> <span class=s1>&#39;mongodb://127.0.0.1:27017/kerwin_session&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>ttl</span><span class=o>:</span> <span class=mi>1000</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>10</span> <span class=c1>// 过期时间
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=o>===</span><span class=s2>&#34;/login&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>garbage</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   	  <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&#34;/login&#34;</span><span class=p>)</span>   
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h5 class="relative group">2. JSON Web Token (JWT)<div id=2-json-web-token-jwt class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-json-web-token-jwt aria-label=Anchor>#</a></span></h5><h6 class="relative group">（1）介绍<div id=1%E4%BB%8B%E7%BB%8D class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E4%BB%8B%E7%BB%8D aria-label=Anchor>#</a></span></h6><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220415082822828.png alt=image-20220415082822828></figure></p><p>我为什么要保存这可恶的session呢， 只让每个客户端去保存该多好？</p><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220415083015066.png alt=image-20220415083015066></figure></p><p>当然， 如果一个人的token 被别人偷走了， 那我也没办法， 我也会认为小偷就是合法用户， 这其实和一个人的session id 被别人偷走是一样的。</p><p>这样一来， 我就不保存session id 了， 我只是生成token , 然后验证token ， 我用我的CPU计算时间获取了我的session 存储空间 ！</p><p>解除了session id这个负担， 可以说是无事一身轻， 我的机器集群现在可以轻松地做水平扩展， 用户访问量增大， 直接加机器就行。 这种无状态的感觉实在是太好了！</p><p>缺点：</p><blockquote><ol><li>占带宽，正常情况下要比 session_id 更大，需要消耗更多流量，挤占更多带宽，假如你的网站每月有 10 万次的浏览器，就意味着要多开销几十兆的流量。听起来并不多，但日积月累也是不小一笔开销。实际上，许多人会在 JWT 中存储的信息会更多；</li><li>无法在服务端注销，那么久很难解决劫持问题；</li><li>性能问题，JWT 的卖点之一就是加密签名，由于这个特性，接收方得以验证 JWT 是否有效且被信任。对于有着严格性能要求的 Web 应用，这并不理想，尤其对于单线程环境。</li></ol></blockquote><p>注意：</p><blockquote><p>CSRF攻击的原因是浏览器会自动带上cookie，而不会带上token；</p><p>以CSRF攻击为例：</p><p>cookie：用户点击了链接，cookie未失效，导致发起请求后后端以为是用户正常操作，于是进行扣款操作；
token：用户点击链接，由于浏览器不会自动带上token，所以即使发了请求，后端的token验证不会通过，所以不会进行扣款操作；</p></blockquote><h6 class="relative group">（2）实现<div id=2%E5%AE%9E%E7%8E%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2%E5%AE%9E%E7%8E%B0 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//jsonwebtoken 封装
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>jsonwebtoken</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;jsonwebtoken&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>secret</span> <span class=o>=</span> <span class=s2>&#34;kerwin&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>JWT</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>generate</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span><span class=nx>exprires</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span><span class=nx>secret</span><span class=p>,{</span><span class=nx>expiresIn</span><span class=o>:</span><span class=nx>exprires</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span><span class=nx>secret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=k>catch</span><span class=p>(</span><span class=nx>e</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>JWT</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//node中间件校验
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果token有效 ,next() 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 如果token过期了, 返回401错误
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=o>===</span><span class=s2>&#34;/login&#34;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s2>&#34;authorization&#34;</span><span class=p>].</span><span class=nx>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>token</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>payload</span> <span class=o>=</span> <span class=nx>JWT</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// console.log(payload)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>payload</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>newToken</span> <span class=o>=</span> <span class=nx>JWT</span><span class=p>.</span><span class=nx>generate</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>_id</span><span class=o>:</span><span class=nx>payload</span><span class=p>.</span><span class=nx>_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span><span class=nx>payload</span><span class=p>.</span><span class=nx>username</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span><span class=s2>&#34;1d&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Authorization&#34;</span><span class=p>,</span><span class=nx>newToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span><span class=nx>errCode</span><span class=o>:</span><span class=s2>&#34;-1&#34;</span><span class=p>,</span><span class=nx>errorInfo</span><span class=o>:</span><span class=s2>&#34;token过期&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl> <span class=c1>//生成token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>JWT</span><span class=p>.</span><span class=nx>generate</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>_id</span><span class=o>:</span> <span class=nx>result</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=nx>result</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>username</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=s2>&#34;1d&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>res</span><span class=p>.</span><span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Authorization&#34;</span><span class=p>,</span> <span class=nx>token</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//前端拦截
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * @作者: kerwin
</span></span></span><span class=line><span class=cl><span class=cm> * @公众号: 大前端私房菜
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>axios</span> <span class=nx>from</span> <span class=s1>&#39;axios&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>// Add a request interceptor
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>axios</span><span class=p>.</span><span class=nx>interceptors</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>config</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>config</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>Authorization</span> <span class=o>=</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>config</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add a response interceptor
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>axios</span><span class=p>.</span><span class=nx>interceptors</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span><span class=nx>authorization</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>headers</span>
</span></span><span class=line><span class=cl>    <span class=nx>authorization</span> <span class=o>&amp;&amp;</span> <span class=nx>localStorage</span><span class=p>.</span><span class=nx>setItem</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>,</span><span class=nx>authorization</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>response</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span><span class=nx>status</span><span class=p>}</span> <span class=o>=</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>status</span><span class=o>===</span><span class=mi>401</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nx>localStorage</span><span class=p>.</span><span class=nx>removeItem</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span><span class=o>=</span><span class=s2>&#34;/login&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span></code></pre></div><h4 class="relative group">六、文件上传管理<div id=%E5%85%AD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%AE%A1%E7%90%86 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%85%AD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%AE%A1%E7%90%86 aria-label=Anchor>#</a></span></h4><p>Multer 是一个 node.js 中间件，用于处理 <code>multipart/form-data</code> 类型的表单数据，它主要用于上传文件。</p><p><strong>注意</strong>: Multer 不会处理任何非 <code>multipart/form-data</code> 类型的表单数据。</p><pre tabindex=0><code>npm install --save multer
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//前后端分离-前端
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>params</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FormData</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;kerwinfile&#39;</span><span class=p>,</span> <span class=nx>file</span><span class=p>.</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>params</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span><span class=s2>&#34;multipart/form-data&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/upload&#39;</span><span class=p>,</span> <span class=nx>params</span><span class=p>,</span> <span class=nx>config</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>res</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=p>.</span><span class=nx>imgpath</span> <span class=o>=</span> <span class=s1>&#39;http://localhost:3000&#39;</span> <span class=o>+</span> <span class=nx>res</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl><span class=p>})</span>	
</span></span></code></pre></div><p>Multer 会添加一个 <code>body</code> 对象 以及 <code>file</code> 或 <code>files</code> 对象 到 express 的 <code>request</code> 对象中。 <code>body</code> 对象包含表单的文本域信息，<code>file</code> 或 <code>files</code> 对象包含对象表单上传的文件信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//前后端分离-后端
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/upload&#39;</span><span class=p>,</span> <span class=nx>upload</span><span class=p>.</span><span class=nx>single</span><span class=p>(</span><span class=s1>&#39;kerwinfile&#39;</span><span class=p>),</span><span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h4 class="relative group">七、APIDOC - API 文档生成工具<div id=%E4%B8%83apidoc---api-%E6%96%87%E6%A1%A3%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%B8%83apidoc---api-%E6%96%87%E6%A1%A3%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7 aria-label=Anchor>#</a></span></h4><p>apidoc 是一个简单的 RESTful API 文档生成工具，它从代码注释中提取特定格式的内容生成文档。支持诸如 Go、Java、C++、Rust 等大部分开发语言，具体可使用 <code>apidoc lang</code> 命令行查看所有的支持列表。</p><p>apidoc 拥有以下特点：</p><ol><li>跨平台，linux、windows、macOS 等都支持；</li><li>支持语言广泛，即使是不支持，也很方便扩展；</li><li>支持多个不同语言的多个项目生成一份文档；</li><li>输出模板可自定义；</li><li>根据文档生成 mock 数据；</li></ol><pre tabindex=0><code>npm install -g apidoc
</code></pre><h2 class="relative group"><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220415085343339.png alt=image-20220415085343339></figure><div id=image-20220415085343339nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0assetsimage-20220415085343339png class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#image-20220415085343339nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0assetsimage-20220415085343339png aria-label=Anchor>#</a></span></h2><p>注意：</p><p>(1) 在当前文件夹下 apidoc.json</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;****接口文档&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;关于****的接口文档描述&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;****&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>（2）可以利用vscode apidoc snippets 插件创建api</p><h4 class="relative group">八、Koa2<div id=%E5%85%ABkoa2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%85%ABkoa2 aria-label=Anchor>#</a></span></h4><img src=nodejs速览笔记.assets/image-20220417075653414.png alt=image-20220417075653414 style=zoom:50%><h5 class="relative group">1.简介<div id=1%E7%AE%80%E4%BB%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E7%AE%80%E4%BB%8B aria-label=Anchor>#</a></span></h5><p>koa 是由 Express 原班人马打造的，致力于成为一个更小、更富有表现力、更健壮的 Web 框架。使用 koa 编写 web 应用，通过组合不同的 generator，可以免除重复繁琐的回调函数嵌套，并极大地提升错误处理的效率。koa 不在内核方法中绑定任何中间件，它仅仅提供了一个轻量优雅的函数库，使得编写 Web 应用变得得心应手。</p><h5 class="relative group">2. 快速开始<div id=2-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B aria-label=Anchor>#</a></span></h5><h6 class="relative group">2.1 安装koa2<div id=21-%E5%AE%89%E8%A3%85koa2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-%E5%AE%89%E8%A3%85koa2 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-s data-lang=s><span class=line><span class=cl><span class=c1># 初始化package.json</span>
</span></span><span class=line><span class=cl><span class=n>npm</span> <span class=n>init</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装koa2 </span>
</span></span><span class=line><span class=cl><span class=n>npm</span> <span class=n>install</span> <span class=n>koa</span>
</span></span></code></pre></div><h6 class="relative group">2.2 hello world 代码<div id=22-hello-world-%E4%BB%A3%E7%A0%81 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-hello-world-%E4%BB%A3%E7%A0%81 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span> <span class=kr>async</span> <span class=p>(</span> <span class=nx>ctx</span> <span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span> <span class=o>=</span> <span class=s1>&#39;hello koa2&#39;</span> <span class=c1>//json数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220417092053231.png alt=image-20220417092053231></figure></p><h6 class="relative group">2.3 启动demo<div id=23-%E5%90%AF%E5%8A%A8demo class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#23-%E5%90%AF%E5%8A%A8demo aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-s data-lang=s><span class=line><span class=cl><span class=n>node</span> <span class=n>index.js</span>
</span></span></code></pre></div><h5 class="relative group">3. koa vs express<div id=3-koa-vs-express class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-koa-vs-express aria-label=Anchor>#</a></span></h5><p>通常都会说 Koa 是洋葱模型，这重点在于中间件的设计。但是按照上面的分析，会发现 Express 也是类似的，不同的是Express 中间件机制使用了 Callback 实现，这样如果出现异步则可能会使你在执行顺序上感到困惑，因此如果我们想做接口耗时统计、错误处理 Koa 的这种中间件模式处理起来更方便些。最后一点响应机制也很重要，Koa 不是立即响应，是整个中间件处理完成在最外层进行了响应，而 Express 则是立即响应。</p><h6 class="relative group">3.1更轻量<div id=31%E6%9B%B4%E8%BD%BB%E9%87%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#31%E6%9B%B4%E8%BD%BB%E9%87%8F aria-label=Anchor>#</a></span></h6><ul><li>koa 不提供内置的中间件；</li><li>koa 不提供路由，而是把路由这个库分离出来了（koa/router）</li></ul><h6 class="relative group">3.2 Context对象<div id=32-context%E5%AF%B9%E8%B1%A1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#32-context%E5%AF%B9%E8%B1%A1 aria-label=Anchor>#</a></span></h6><p>koa增加了一个Context的对象，作为这次请求的上下文对象（在koa2中作为中间件的第一个参数传入）。同时Context上也挂载了Request和Response两个对象。和Express类似，这两个对象都提供了大量的便捷方法辅助开发, 这样的话对于在保存一些公有的参数的话变得更加合情合理</p><h6 class="relative group">3.3 异步流程控制<div id=33-%E5%BC%82%E6%AD%A5%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#33-%E5%BC%82%E6%AD%A5%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6 aria-label=Anchor>#</a></span></h6><p>​ express采用callback来处理异步， koa v1采用generator，koa v2 采用async/await。</p><p>​ generator和async/await使用同步的写法来处理异步，明显好于callback和promise，</p><h6 class="relative group">3.4 中间件模型<div id=34-%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A8%A1%E5%9E%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#34-%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A8%A1%E5%9E%8B aria-label=Anchor>#</a></span></h6><p>​ express基于connect中间件，线性模型；</p><p>​ koa中间件采用洋葱模型（对于每个中间件，在完成了一些事情后，可以非常优雅的将控制权传递给下一个中间件，并能够等待它完成，当后续的中间件完成处理后，控制权又回到了自己）</p><img src=nodejs速览笔记.assets/image-20220417083817823.png alt=image-20220417083817823 style=zoom:50%;float:left><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220417085913567.png alt=image-20220417085913567></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//同步
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;express&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//异步
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;express&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span><span class=nx>res</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>async</span> <span class=p>()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>delay</span><span class=p>(</span><span class=nx>time</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span><span class=nx>reject</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//同步
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>ctx</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=s2>&#34;hello&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//异步
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=s2>&#34;hello&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> 
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>async</span> <span class=p>()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>delay</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>delay</span><span class=p>(</span><span class=nx>time</span><span class=p>){</span>
</span></span><span class=line><span class=cl> <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span><span class=nx>reject</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><h5 class="relative group">4. 路由<div id=4-%E8%B7%AF%E7%94%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-%E8%B7%AF%E7%94%B1 aria-label=Anchor>#</a></span></h5><h6 class="relative group">4.1基本用发<div id=41%E5%9F%BA%E6%9C%AC%E7%94%A8%E5%8F%91 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#41%E5%9F%BA%E6%9C%AC%E7%94%A8%E5%8F%91 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Router</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa-router&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Router</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/list&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;111&#34;</span><span class=p>,</span><span class=s2>&#34;222&#34;</span><span class=p>,</span><span class=s2>&#34;333&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nx>routes</span><span class=p>()).</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nx>allowedMethods</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">4.2 router.allowedMethods作用<div id=42-routerallowedmethods%E4%BD%9C%E7%94%A8 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#42-routerallowedmethods%E4%BD%9C%E7%94%A8 aria-label=Anchor>#</a></span></h6><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220417102845079.png alt=image-20220417102845079></figure></p><h6 class="relative group">4.3 请求方式<div id=43-%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#43-%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F aria-label=Anchor>#</a></span></h6><p>Koa-router 请求方式： <code>get</code> 、 <code>put</code> 、 <code>post</code> 、 <code>patch</code> 、 <code>delete</code> 、 <code>del</code> ，而使用方法就是 <code>router.方式()</code> ，比如 <code>router.get()</code> 和 <code>router.post()</code> 。而 <code>router.all()</code> 会匹配所有的请求方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Router</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa-router&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Router</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/user&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;aaa&#34;</span><span class=p>,</span><span class=s2>&#34;bbb&#34;</span><span class=p>,</span><span class=s2>&#34;ccc&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/user/:id&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span><span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span><span class=nx>info</span><span class=o>:</span><span class=s2>&#34;user update&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/user&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span><span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span><span class=nx>info</span><span class=o>:</span><span class=s2>&#34;user post&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=s2>&#34;/user/:id&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span><span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span><span class=nx>info</span><span class=o>:</span><span class=s2>&#34;user del&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nx>routes</span><span class=p>()).</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nx>allowedMethods</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">4.4 拆分路由<div id=44-%E6%8B%86%E5%88%86%E8%B7%AF%E7%94%B1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#44-%E6%8B%86%E5%88%86%E8%B7%AF%E7%94%B1 aria-label=Anchor>#</a></span></h6><p>list.js</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Router</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa-router&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Router</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;111&#34;</span><span class=p>,</span><span class=s2>&#34;222&#34;</span><span class=p>,</span><span class=s2>&#34;333&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span><span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span><span class=nx>info</span><span class=o>:</span><span class=s2>&#34;list update&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span><span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span><span class=nx>info</span><span class=o>:</span><span class=s2>&#34;list post&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span><span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span><span class=nx>info</span><span class=o>:</span><span class=s2>&#34;list del&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>router</span>
</span></span></code></pre></div><p>index.js</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Router</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa-router&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Router</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>list</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./list&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/user&#39;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>routes</span><span class=p>(),</span> <span class=nx>user</span><span class=p>.</span><span class=nx>allowedMethods</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/list&#39;</span><span class=p>,</span> <span class=nx>list</span><span class=p>.</span><span class=nx>routes</span><span class=p>(),</span> <span class=nx>list</span><span class=p>.</span><span class=nx>allowedMethods</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>router</span>
</span></span></code></pre></div><p>entry入口</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>Koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;koa&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;./router/index&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nx>routes</span><span class=p>()).</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>.</span><span class=nx>allowedMethods</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">4.5 路由前缀<div id=45-%E8%B7%AF%E7%94%B1%E5%89%8D%E7%BC%80 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#45-%E8%B7%AF%E7%94%B1%E5%89%8D%E7%BC%80 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>prefix</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>)</span>
</span></span></code></pre></div><h6 class="relative group">4.6 路由重定向<div id=46-%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#46-%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/home&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=s2>&#34;home页面&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>//写法1 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=s1>&#39;/home&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>//写法2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,(</span><span class=nx>ctx</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&#34;/home&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h5 class="relative group">5. 静态资源<div id=5--%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5--%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=kr>static</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa-static&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>static</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span> <span class=nx>__dirname</span><span class=p>,</span>  <span class=s2>&#34;public&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span> <span class=kr>async</span> <span class=p>(</span> <span class=nx>ctx</span> <span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span> <span class=o>=</span> <span class=s1>&#39;hello world&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;[demo] static-use-middleware is starting at port 3000&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h5 class="relative group">6. 获取请求参数<div id=6--%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6--%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0 aria-label=Anchor>#</a></span></h5><h6 class="relative group">6.1get参数<div id=61get%E5%8F%82%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#61get%E5%8F%82%E6%95%B0 aria-label=Anchor>#</a></span></h6><p>在koa中，获取GET请求数据源头是koa中request对象中的query方法或querystring方法，query返回是格式化好的参数对象，querystring返回的是请求字符串，由于ctx对request的API有直接引用的方式，所以获取GET请求数据有两个途径。</p><ul><li>是从上下文中直接获取 请求对象ctx.query，返回如 { a:1, b:2 } 请求字符串 ctx.querystring，返回如 a=1&amp;b=2</li><li>是从上下文的request对象中获取 请求对象ctx.request.query，返回如 { a:1, b:2 } 请求字符串 ctx.request.querystring，返回如 a=1&amp;b=2</li></ul><h6 class="relative group">6.2post参数<div id=62post%E5%8F%82%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#62post%E5%8F%82%E6%95%B0 aria-label=Anchor>#</a></span></h6><p>对于POST请求的处理，koa-bodyparser中间件可以把koa2上下文的formData数据解析到ctx.request.body中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bodyParser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa-bodyparser&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用ctx.body解析中间件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>bodyParser</span><span class=p>())</span>
</span></span></code></pre></div><h5 class="relative group">7. ejs模板<div id=7-ejs%E6%A8%A1%E6%9D%BF class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#7-ejs%E6%A8%A1%E6%9D%BF aria-label=Anchor>#</a></span></h5><h6 class="relative group">7.1 安装模块<div id=71-%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#71-%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h6><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=err>#</span> <span class=nx>安装koa模板使用中间件</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>install</span> <span class=o>--</span><span class=nx>save</span> <span class=nx>koa</span><span class=o>-</span><span class=nx>views</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=nx>安装ejs模板引擎</span>
</span></span><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>install</span> <span class=o>--</span><span class=nx>save</span> <span class=nx>ejs</span>
</span></span></code></pre></div><h6 class="relative group">7.2 使用模板引擎<div id=72-%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#72-%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E aria-label=Anchor>#</a></span></h6><p><strong>文件目录</strong></p><pre tabindex=0><code>├── package.json
├── index.js
└── view
    └── index.ejs
</code></pre><p><strong>./index.js文件</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Koa</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>views</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa-views&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Koa</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 加载模板引擎
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>views</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span> <span class=s1>&#39;./view&#39;</span><span class=p>),</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>extension</span><span class=o>:</span> <span class=s1>&#39;ejs&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span> <span class=kr>async</span> <span class=p>(</span> <span class=nx>ctx</span> <span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>title</span> <span class=o>=</span> <span class=s1>&#39;hello koa2&#39;</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span></code></pre></div><p><strong>./view/index.ejs 模板</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span><span class=err>&lt;</span>%= title %&gt;<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span><span class=err>&lt;</span>%= title %&gt;<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>EJS Welcome to <span class=err>&lt;</span>%= title %&gt;<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><h5 class="relative group">8. cookie&amp;session<div id=8-cookiesession class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#8-cookiesession aria-label=Anchor>#</a></span></h5><h6 class="relative group">8.1 cookie<div id=81-cookie class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#81-cookie aria-label=Anchor>#</a></span></h6><p>koa提供了从上下文直接读取、写入cookie的方法</p><ul><li>ctx.cookies.get(name, [options]) 读取上下文请求中的cookie</li><li>ctx.cookies.set(name, value, [options]) 在上下文中写入cookie</li></ul><h6 class="relative group">8.2 session<div id=82-session class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#82-session aria-label=Anchor>#</a></span></h6><ul><li><p>koa-session-minimal 适用于koa2 的session中间件，提供存储介质的读写接口 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;koa-session-minimal&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;SESSION_ID&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cookie</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxAge</span><span class=o>:</span><span class=mi>1000</span><span class=o>*</span><span class=mi>60</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//排除login相关的路由和接口
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>url</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;login&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//重新设置以下sesssion
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ctx</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>mydate</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&#34;/login&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div></li></ul><h5 class="relative group">9. JWT<div id=9-jwt class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#9-jwt aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=kr>async</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//排除login相关的路由和接口
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>if</span> <span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>url</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;login&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=k>return</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s2>&#34;authorization&#34;</span><span class=p>]</span><span class=o>?</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=c1>// console.log(req.headers[&#34;authorization&#34;])
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>if</span><span class=p>(</span><span class=nx>token</span><span class=p>){</span>
</span></span><span class=line><span class=cl>     <span class=kr>const</span> <span class=nx>payload</span><span class=o>=</span>  <span class=nx>JWT</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=k>if</span><span class=p>(</span><span class=nx>payload</span><span class=p>){</span>
</span></span><span class=line><span class=cl>         <span class=c1>//重新计算token过期时间
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=kr>const</span> <span class=nx>newToken</span> <span class=o>=</span> <span class=nx>JWT</span><span class=p>.</span><span class=nx>generate</span><span class=p>({</span>
</span></span><span class=line><span class=cl>             <span class=nx>_id</span><span class=o>:</span><span class=nx>payload</span><span class=p>.</span><span class=nx>_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nx>username</span><span class=o>:</span><span class=nx>payload</span><span class=p>.</span><span class=nx>username</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span><span class=s2>&#34;10s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nx>ctx</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&#34;Authorization&#34;</span><span class=p>,</span><span class=nx>newToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>ctx</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=mi>401</span>
</span></span><span class=line><span class=cl>         <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span> <span class=o>=</span> <span class=p>{</span><span class=nx>errCode</span><span class=o>:-</span><span class=mi>1</span><span class=p>,</span><span class=nx>errInfo</span><span class=o>:</span><span class=s2>&#34;token过期&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=kr>await</span> <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h5 class="relative group"><div id=heading class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#heading aria-label=Anchor>#</a></span></h5><h5 class="relative group">10.上传文件<div id=10%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#10%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6 aria-label=Anchor>#</a></span></h5><blockquote><p><a href=https://www.npmjs.com/package/@koa/multer target=_blank>https://www.npmjs.com/package/@koa/multer</a></p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>npm</span> <span class=nx>install</span> <span class=o>--</span><span class=nx>save</span> <span class=err>@</span><span class=nx>koa</span><span class=o>/</span><span class=nx>multer</span> <span class=nx>multer</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>multer</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;@koa/multer&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>upload</span> <span class=o>=</span> <span class=nx>multer</span><span class=p>({</span> <span class=nx>dest</span><span class=o>:</span> <span class=s1>&#39;public/uploads/&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span><span class=nx>upload</span><span class=p>.</span><span class=nx>single</span><span class=p>(</span><span class=s1>&#39;avatar&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=nx>next</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ok</span><span class=o>:</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>info</span><span class=o>:</span><span class=s2>&#34;add user success&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><h5 class="relative group">11.操作MongoDB<div id=11%E6%93%8D%E4%BD%9Cmongodb class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11%E6%93%8D%E4%BD%9Cmongodb aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mongoose</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;mongoose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mongoose</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=s2>&#34;mongodb://127.0.0.1:27017/kerwin_project&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//插入集合和数据,数据库kerwin_project会自动创建
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mongoose</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;mongoose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>Schema</span> <span class=o>=</span> <span class=nx>mongoose</span><span class=p>.</span><span class=nx>Schema</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span><span class=o>:</span><span class=nb>Number</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>avatar</span><span class=o>:</span><span class=nb>String</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserModel</span> <span class=o>=</span> <span class=nx>mongoose</span><span class=p>.</span><span class=nx>model</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span><span class=k>new</span> <span class=nx>Schema</span><span class=p>(</span><span class=nx>UserType</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1>// 模型user 将会对应 users 集合, 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>UserModel</span>
</span></span></code></pre></div><h4 class="relative group">九、MySQL<div id=%E4%B9%9Dmysql class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E4%B9%9Dmysql aria-label=Anchor>#</a></span></h4><h5 class="relative group">1.介绍<div id=1%E4%BB%8B%E7%BB%8D-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E4%BB%8B%E7%BB%8D-1 aria-label=Anchor>#</a></span></h5><p>付费的商用数据库：</p><ul><li>Oracle，典型的高富帅；</li><li>SQL Server，微软自家产品，Windows定制专款；</li><li>DB2，IBM的产品，听起来挺高端；</li><li>Sybase，曾经跟微软是好基友，后来关系破裂，现在家境惨淡。</li></ul><p>这些数据库都是不开源而且付费的，最大的好处是花了钱出了问题可以找厂家解决，不过在Web的世界里，常常需要部署成千上万的数据库服务器，当然不能把大把大把的银子扔给厂家，所以，无论是Google、Facebook，还是国内的BAT，无一例外都选择了免费的开源数据库：</p><ul><li>MySQL，大家都在用，一般错不了；</li><li>PostgreSQL，学术气息有点重，其实挺不错，但知名度没有MySQL高；</li><li>sqlite，嵌入式数据库，适合桌面和移动应用。</li></ul><p>作为一个JavaScript全栈工程师，选择哪个免费数据库呢？当然是MySQL。因为MySQL普及率最高，出了错，可以很容易找到解决方法。而且，围绕MySQL有一大堆监控和运维的工具，安装和使用很方便。</p><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220420083146539.png alt=image-20220420083146539></figure></p><h5 class="relative group">2.与非关系数据库区别<div id=2%E4%B8%8E%E9%9D%9E%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8C%BA%E5%88%AB class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2%E4%B8%8E%E9%9D%9E%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8C%BA%E5%88%AB aria-label=Anchor>#</a></span></h5><p>关系型和非关系型数据库的主要差异是数据存储的方式。关系型数据天然就是表格式的，因此存储在数据表的行和列中。数据表可以彼此关联协作存储，也很容易提取数据。</p><p>与其相反，非关系型数据不适合存储在数据表的行和列中，而是大块组合在一起。非关系型数据通常存储在数据集中，就像文档、键值对或者图结构。你的数据及其特性是选择数据存储和提取方式的首要影响因素。</p><p><strong>关系型数据库最典型的数据结构是表，由二维表及其之间的联系所组成的一个数据组织</strong>
优点：
1、易于维护：都是使用表结构，格式一致；
2、使用方便：SQL语言通用，可用于复杂查询；
3、复杂操作：支持SQL，可用于一个表以及多个表之间非常复杂的查询。
缺点：
1、读写性能比较差，尤其是海量数据的高效率读写；
2、固定的表结构，灵活度稍欠；
3、高并发读写需求，传统关系型数据库来说，硬盘I/O是一个很大的瓶颈。</p><p><strong>非关系型数据库严格上不是一种数据库，应该是一种数据结构化存储方法的集合，可以是文档或者键值对等。</strong></p><p>优点：</p><p>1、格式灵活：存储数据的格式可以是key,value形式、文档形式、图片形式等等，文档形式、图片形式等等，使用灵活，应用场景广泛，而关系型数据库则只支持基础类型。
2、速度快：nosql可以使用硬盘或者随机存储器作为载体，而关系型数据库只能使用硬盘；
3、高扩展性；
4、成本低：nosql数据库部署简单，基本都是开源软件。</p><p>缺点：</p><p>1、不提供sql支持；
2、无事务处理；
3、数据结构相对复杂，复杂查询方面稍欠。</p><h5 class="relative group">3.sql语句<div id=3sql%E8%AF%AD%E5%8F%A5 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3sql%E8%AF%AD%E5%8F%A5 aria-label=Anchor>#</a></span></h5><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220420092527846.png alt=image-20220420092527846></figure></p><p>插入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=p>(</span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>name</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>score</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>gender</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=k>null</span><span class=p>,</span><span class=s1>&#39;kerwin&#39;</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=err>可以不设置</span><span class=n>id</span><span class=p>,</span><span class=n>create_time</span><span class=w>
</span></span></span></code></pre></div><p>更新：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=o>`</span><span class=n>name</span><span class=o>`=</span><span class=s1>&#39;tiechui&#39;</span><span class=p>,</span><span class=o>`</span><span class=n>score</span><span class=o>`=</span><span class=mi>20</span><span class=p>,</span><span class=o>`</span><span class=n>gender</span><span class=o>`=</span><span class=mi>0</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>删除：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=err>查所有的数据所有的字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>查所有的数据某个字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>`</span><span class=n>id</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>name</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>score</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>gender</span><span class=o>`</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>条件查询</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>score</span><span class=o>&gt;=</span><span class=mi>80</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>score</span><span class=o>&gt;=</span><span class=mi>80</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>gender</span><span class=o>=</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>模糊查询</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>students</span><span class=o>`</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;%k%&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>排序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>gender</span><span class=p>,</span><span class=w> </span><span class=n>score</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>score</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>gender</span><span class=p>,</span><span class=w> </span><span class=n>score</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>score</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>分页查询</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>gender</span><span class=p>,</span><span class=w> </span><span class=n>score</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>50</span><span class=w> </span><span class=k>OFFSET</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>记录条数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>kerwinnum</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>多表查询</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=p>,</span><span class=w> </span><span class=n>classes</span><span class=p>;</span><span class=err>（这种多表查询又称笛卡尔查询，使用笛卡尔查询时要非常小心，由于结果集是目标表的行数乘积，对两个各自有</span><span class=mi>100</span><span class=err>行记录的表进行笛卡尔查询将返回</span><span class=mi>1</span><span class=err>万条记录，对两个各自有</span><span class=mi>1</span><span class=err>万行记录的表进行笛卡尔查询将返回</span><span class=mi>1</span><span class=err>亿条记录）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>students</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=n>sid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>students</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>students</span><span class=p>.</span><span class=n>gender</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>students</span><span class=p>.</span><span class=n>score</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>classes</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=n>cid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>classes</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=n>cname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=p>,</span><span class=w> </span><span class=n>classes</span><span class=p>;</span><span class=w> </span><span class=err>（要使用表名</span><span class=p>.</span><span class=err>列名这样的方式来引用列和设置别名，这样就避免了结果集的列名重复问题。）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=n>sid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>s</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>s</span><span class=p>.</span><span class=n>gender</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>s</span><span class=p>.</span><span class=n>score</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>c</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=n>cid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>c</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=n>cname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>classes</span><span class=w> </span><span class=k>c</span><span class=p>;</span><span class=w> </span><span class=err>（</span><span class=n>SQL还允许给表设置一个别名</span><span class=err>）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>联表查询</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>class_id</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=n>class_name</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>gender</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>students</span><span class=w> </span><span class=n>s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>classes</span><span class=w> </span><span class=k>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ON</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>class_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>id</span><span class=p>;</span><span class=w> </span><span class=err>（连接查询对多个表进行</span><span class=n>JOIN运算</span><span class=err>，简单地说，就是先确定一个主表作为结果集，然后，把其他表的行有选择性地“连接”在主表结果集上。）</span><span class=w>
</span></span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220420090841742.png alt=image-20220420090841742></figure></p><p>注意：</p><blockquote><ol><li>InnoDB 支持事务，MyISAM 不支持事务。这是 MySQL 将默认存储引擎从 MyISAM 变成 InnoDB 的重要原因之一；</li><li>InnoDB 支持外键，而 MyISAM 不支持。对一个包含外键的 InnoDB 表转为 MYISAM 会失败；</li></ol></blockquote><p><strong>外键约束</strong></p><p>CASCADE
在父表上update/delete记录时，同步update/delete掉子表的匹配记录</p><p>SET NULL
在父表上update/delete记录时，将子表上匹配记录的列设为null (要注意子表的外键列不能为not null)</p><p>NO ACTION
如果子表中有匹配的记录,则不允许对父表对应候选键进行update/delete操作</p><p>RESTRICT
同no action, 都是立即检查外键约束</p><h5 class="relative group">4.nodejs 操作数据库<div id=4nodejs-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4nodejs-%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mysql2</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;mysql2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>port</span> <span class=o>=</span> <span class=mi>9000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span><span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=nx>getDBConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>promisePool</span> <span class=o>=</span> <span class=nx>mysql2</span><span class=p>.</span><span class=nx>createPool</span><span class=p>(</span><span class=nx>config</span><span class=p>).</span><span class=nx>promise</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=c1>// console.log(promisePool)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>promisePool</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s1>&#39;select * from students&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>//存在用户
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>//不存在
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>code</span><span class=o>:</span> <span class=o>-</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>msg</span><span class=o>:</span> <span class=s1>&#39;user not exsit&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>      
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Example app listening at http://localhost:</span><span class=si>${</span><span class=nx>port</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>getDBConfig</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span><span class=o>:</span> <span class=s1>&#39;root&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>port</span><span class=o>:</span> <span class=mi>3306</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>database</span><span class=o>:</span> <span class=s1>&#39;kerwin_test&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>connectionLimit</span><span class=o>:</span> <span class=mi>1</span> <span class=c1>//创建一个连接池
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>查询</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=nx>promisePool</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s1>&#39;select * from users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>插入</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=nx>promisePool</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s1>&#39;INSERT INTO `users`(`id`,`name`,`age`, `password`) VALUES (?,?,?,?)&#39;</span><span class=p>,[</span><span class=kc>null</span><span class=p>,</span><span class=s2>&#34;kerwin&#34;</span><span class=p>,</span><span class=mi>100</span><span class=p>,</span><span class=s2>&#34;123456&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>更新</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=nx>promisePool</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=sb>`UPDATE users SET name = ? ,age=? WHERE id = ?`</span><span class=p>,[</span><span class=s2>&#34;xiaoming2&#34;</span><span class=p>,</span><span class=mi>20</span><span class=p>,</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>删除</span><span class=err>：</span>
</span></span><span class=line><span class=cl><span class=nx>promisePool</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=sb>`delete from users where id=?`</span><span class=p>,[</span><span class=mi>1</span><span class=p>])</span>
</span></span></code></pre></div><h4 class="relative group">十、Socket编程<div id=%E5%8D%81socket%E7%BC%96%E7%A8%8B class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8D%81socket%E7%BC%96%E7%A8%8B aria-label=Anchor>#</a></span></h4><h5 class="relative group">1.websocket介绍<div id=1websocket%E4%BB%8B%E7%BB%8D class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1websocket%E4%BB%8B%E7%BB%8D aria-label=Anchor>#</a></span></h5><img src=nodejs速览笔记.assets/image-20220421084242097.png alt=image-20220421084242097 style=zoom:50%><p><strong>应用场景：</strong></p><ul><li><p>弹幕</p></li><li><p>媒体聊天</p></li><li><p>协同编辑</p></li><li><p>基于位置的应用</p></li><li><p>体育实况更新</p></li><li><p>股票基金报价实时更新</p></li></ul><p>WebSocket并不是全新的协议，而是利用了HTTP协议来建立连接。我们来看看WebSocket连接是如何创建的。</p><p>首先，WebSocket连接必须由浏览器发起，因为请求协议是一个标准的HTTP请求，格式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>GET</span> <span class=nx>ws</span><span class=o>:</span><span class=c1>//localhost:3000/ws/chat HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Host</span><span class=o>:</span> <span class=nx>localhost</span>
</span></span><span class=line><span class=cl><span class=nx>Upgrade</span><span class=o>:</span> <span class=nx>websocket</span>
</span></span><span class=line><span class=cl><span class=nx>Connection</span><span class=o>:</span> <span class=nx>Upgrade</span>
</span></span><span class=line><span class=cl><span class=nx>Origin</span><span class=o>:</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//localhost:3000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Sec</span><span class=o>-</span><span class=nx>WebSocket</span><span class=o>-</span><span class=nx>Key</span><span class=o>:</span> <span class=nx>client</span><span class=o>-</span><span class=nx>random</span><span class=o>-</span><span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=nx>Sec</span><span class=o>-</span><span class=nx>WebSocket</span><span class=o>-</span><span class=nx>Version</span><span class=o>:</span> <span class=mi>13</span>
</span></span></code></pre></div><p>该请求和普通的HTTP请求有几点不同：</p><ol><li>GET请求的地址不是类似<code>/path/</code>，而是以<code>ws://</code>开头的地址；</li><li>请求头<code>Upgrade: websocket</code>和<code>Connection: Upgrade</code>表示这个连接将要被转换为WebSocket连接；</li><li><code>Sec-WebSocket-Key</code>是用于标识这个连接，并非用于加密数据；</li><li><code>Sec-WebSocket-Version</code>指定了WebSocket的协议版本。</li></ol><p>随后，服务器如果接受该请求，就会返回如下响应：</p><pre tabindex=0><code>HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: server-random-string
</code></pre><p>该响应代码<code>101</code>表示本次连接的HTTP协议即将被更改，更改后的协议就是<code>Upgrade: websocket</code>指定的WebSocket协议。</p><p>版本号和子协议规定了双方能理解的数据格式，以及是否支持压缩等等。如果仅使用WebSocket的API，就不需要关心这些。</p><p>现在，一个WebSocket连接就建立成功，浏览器和服务器就可以随时主动发送消息给对方。消息有两种，一种是文本，一种是二进制数据。通常，我们可以发送JSON格式的文本，这样，在浏览器处理起来就十分容易。</p><p>为什么WebSocket连接可以实现全双工通信而HTTP连接不行呢？实际上HTTP协议是建立在TCP协议之上的，TCP协议本身就实现了全双工通信，但是HTTP协议的请求－应答机制限制了全双工通信。WebSocket连接建立以后，其实只是简单规定了一下：接下来，咱们通信就不使用HTTP协议了，直接互相发数据吧。</p><p>安全的WebSocket连接机制和HTTPS类似。首先，浏览器用<code>wss://xxx</code>创建WebSocket连接时，会先通过HTTPS创建安全的连接，然后，该HTTPS连接升级为WebSocket连接，底层通信走的仍然是安全的SSL/TLS协议。</p><p><strong>浏览器支持</strong></p><p>很显然，要支持WebSocket通信，浏览器得支持这个协议，这样才能发出<code>ws://xxx</code>的请求。目前，支持WebSocket的主流浏览器如下：</p><ul><li>Chrome</li><li>Firefox</li><li>IE >= 10</li><li>Sarafi >= 6</li><li>Android >= 4.4</li><li>iOS >= 8</li></ul><p><strong>服务器支持</strong></p><p>由于WebSocket是一个协议，服务器具体怎么实现，取决于所用编程语言和框架本身。Node.js本身支持的协议包括TCP协议和HTTP协议，要支持WebSocket协议，需要对Node.js提供的HTTPServer做额外的开发。已经有若干基于Node.js的稳定可靠的WebSocket实现，我们直接用npm安装使用即可。</p><h5 class="relative group">2.ws模块<div id=2ws%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2ws%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h5><p>服务器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span>  <span class=nx>WebSocket</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;ws&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>WebSocketServer</span> <span class=o>=</span> <span class=nx>WebSocket</span><span class=p>.</span><span class=nx>WebSocketServer</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>wss</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocketServer</span><span class=p>({</span> <span class=nx>port</span><span class=o>:</span> <span class=mi>8080</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>wss</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>connection</span><span class=p>(</span><span class=nx>ws</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>message</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>isBinary</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=nx>each</span><span class=p>(</span><span class=nx>client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>client</span> <span class=o>!==</span> <span class=nx>ws</span> <span class=o>&amp;&amp;</span> <span class=nx>client</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>===</span> <span class=nx>WebSocket</span><span class=p>.</span><span class=nx>OPEN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>client</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=p>{</span> <span class=nx>binary</span><span class=o>:</span> <span class=nx>isBinary</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;欢迎加入聊天室&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>客户端：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=s2>&#34;ws://localhost:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>ws</span><span class=p>.</span><span class=nx>onopen</span> <span class=o>=</span> <span class=p>()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;open&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>ws</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=p>(</span><span class=nx>evt</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>evt</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>授权验证：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//前端
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=sb>`ws://localhost:8080?token=</span><span class=si>${</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>ws</span><span class=p>.</span><span class=nx>onopen</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;open&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span>
</span></span><span class=line><span class=cl>      <span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>ws</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=p>(</span><span class=nx>evt</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>evt</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//后端
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>WebSocket</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s2>&#34;ws&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>JWT</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;../util/JWT&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>WebSocketServer</span> <span class=o>=</span> <span class=nx>WebSocket</span><span class=p>.</span><span class=nx>WebSocketServer</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>wss</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocketServer</span><span class=p>({</span> <span class=nx>port</span><span class=o>:</span> <span class=mi>8080</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>wss</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>connection</span><span class=p>(</span><span class=nx>ws</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>myURL</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s1>&#39;http://127.0.0.1:3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=nx>JWT</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>myURL</span><span class=p>.</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>payload</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=nx>payload</span>
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createMessage</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=s2>&#34;欢迎来到聊天室&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>sendBroadList</span><span class=p>()</span> <span class=c1>//发送好友列表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createMessage</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nb>Error</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=s2>&#34;token过期&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// console.log(3333,url)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>ws</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>message</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>isBinary</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>messageObj</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>messageObj</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createMessage</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>,</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>).</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>user</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=nx>each</span><span class=p>(</span><span class=nx>client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>client</span> <span class=o>!==</span> <span class=nx>ws</span> <span class=o>&amp;&amp;</span> <span class=nx>client</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>===</span> <span class=nx>WebSocket</span><span class=p>.</span><span class=nx>OPEN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>client</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createMessage</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>SingleChat</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=nx>each</span><span class=p>(</span><span class=nx>client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>client</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>to</span> <span class=o>&amp;&amp;</span> <span class=nx>client</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>===</span> <span class=nx>WebSocket</span><span class=p>.</span><span class=nx>OPEN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>client</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createMessage</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>SingleChat</span><span class=p>,</span> <span class=nx>ws</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ws</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;close&#34;</span><span class=p>,</span><span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>      <span class=c1>//删除当前用户
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=nx>ws</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>sendBroadList</span><span class=p>()</span> <span class=c1>//发送好用列表
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>WebSocketType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>Error</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span> <span class=c1>//错误
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>GroupList</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span><span class=c1>//群列表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>GroupChat</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span><span class=c1>//群聊
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>SingleChat</span><span class=o>:</span> <span class=mi>3</span><span class=c1>//私聊
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createMessage</span><span class=p>(</span><span class=nx>type</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nx>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sendBroadList</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=nx>each</span><span class=p>(</span><span class=nx>client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>client</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>===</span> <span class=nx>WebSocket</span><span class=p>.</span><span class=nx>OPEN</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>createMessage</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>,</span> <span class=nx>client</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>wss</span><span class=p>.</span><span class=nx>clients</span><span class=p>).</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>user</span><span class=p>))))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h5 class="relative group">3.socket.io模块<div id=3socketio%E6%A8%A1%E5%9D%97 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3socketio%E6%A8%A1%E5%9D%97 aria-label=Anchor>#</a></span></h5><p>服务端：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>io</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;socket.io&#39;</span><span class=p>)(</span><span class=nx>server</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>io</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connection&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>socket</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=nx>JWT</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>socket</span><span class=p>.</span><span class=nx>handshake</span><span class=p>.</span><span class=nx>query</span><span class=p>.</span><span class=nx>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>payload</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=nx>payload</span>
</span></span><span class=line><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,</span> <span class=nx>createMessage</span><span class=p>(</span><span class=nx>socket</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=s2>&#34;欢迎来到聊天室&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>sendBroadList</span><span class=p>()</span> <span class=c1>//发送好友列表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nb>Error</span><span class=p>,</span> <span class=nx>createMessage</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=s2>&#34;token过期&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>,</span> <span class=nx>createMessage</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>io</span><span class=p>.</span><span class=nx>sockets</span><span class=p>.</span><span class=nx>sockets</span><span class=p>).</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>user</span><span class=p>).</span><span class=nx>filter</span><span class=p>(</span><span class=nx>item</span><span class=p>=&gt;</span><span class=nx>item</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,</span> <span class=p>(</span><span class=nx>messageObj</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>socket</span><span class=p>.</span><span class=nx>broadcast</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,</span> <span class=nx>createMessage</span><span class=p>(</span><span class=nx>socket</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>SingleChat</span><span class=p>,</span> <span class=p>(</span><span class=nx>messageObj</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>io</span><span class=p>.</span><span class=nx>sockets</span><span class=p>.</span><span class=nx>sockets</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>socket</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>socket</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>to</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>socket</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>SingleChat</span><span class=p>,</span> <span class=nx>createMessage</span><span class=p>(</span><span class=nx>socket</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>user</span><span class=p>,</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;disconnect&#39;</span><span class=p>,</span> <span class=nx>reason</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>     <span class=nx>sendBroadList</span><span class=p>()</span> <span class=c1>//发送好用列表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sendBroadList</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>io</span><span class=p>.</span><span class=nx>sockets</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>,</span> <span class=nx>createMessage</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>from</span><span class=p>(</span><span class=nx>io</span><span class=p>.</span><span class=nx>sockets</span><span class=p>.</span><span class=nx>sockets</span><span class=p>).</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>user</span><span class=p>).</span><span class=nx>filter</span><span class=p>(</span><span class=nx>item</span><span class=p>=&gt;</span><span class=nx>item</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//最后filter，是因为 有可能存在null的值
</span></span></span></code></pre></div><p>客户端：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>WebSocketType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Error</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span> <span class=c1>//错误
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>GroupList</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=c1>//群列表
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>GroupChat</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span> <span class=c1>//群聊
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>SingleChat</span><span class=o>:</span> <span class=mi>3</span> <span class=c1>//私聊
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>socket</span> <span class=o>=</span> <span class=nx>io</span><span class=p>(</span><span class=sb>`ws://localhost:3000?token=</span><span class=si>${</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>&#34;connect&#34;</span><span class=p>,()=&gt;{</span>
</span></span><span class=line><span class=cl>	<span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupList</span><span class=p>,</span> <span class=p>(</span><span class=nx>messageObj</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>select</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>select</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=sb>`&lt;option value=&#34;all&#34;&gt;all&lt;/option&gt;`</span> <span class=o>+</span> <span class=nx>messageObj</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>    &lt;option value=&#34;</span><span class=si>${</span><span class=nx>item</span><span class=p>.</span><span class=nx>username</span><span class=si>}</span><span class=sb>&#34;&gt;</span><span class=si>${</span><span class=nx>item</span><span class=p>.</span><span class=nx>username</span><span class=si>}</span><span class=sb>&lt;/option&gt;`</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,</span> <span class=p>(</span><span class=nx>msg</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>SingleChat</span><span class=p>,</span> <span class=p>(</span><span class=nx>msg</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>socket</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nb>Error</span><span class=p>,</span> <span class=p>(</span><span class=nx>msg</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>localStorage</span><span class=p>.</span><span class=nx>removeItem</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=s2>&#34;/login&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>send</span><span class=p>.</span><span class=nx>onclick</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>select</span><span class=p>.</span><span class=nx>value</span> <span class=o>===</span> <span class=s2>&#34;all&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>GroupChat</span><span class=p>,{</span>
</span></span><span class=line><span class=cl>            <span class=nx>data</span><span class=o>:</span> <span class=nx>text</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>socket</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=nx>WebSocketType</span><span class=p>.</span><span class=nx>SingleChat</span><span class=p>,{</span>
</span></span><span class=line><span class=cl>            <span class=nx>data</span><span class=o>:</span> <span class=nx>text</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>to</span><span class=o>:</span><span class=nx>select</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 class="relative group">十一、mocha<div id=%E5%8D%81%E4%B8%80mocha class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%E5%8D%81%E4%B8%80mocha aria-label=Anchor>#</a></span></h4><p>单元测试是用来对一个模块、一个函数或者一个类来进行正确性检验的测试工作。</p><p>比如对函数abs()，我们可以编写出以下几个测试用例：</p><p>输入正数，比如1、1.2、0.99，期待返回值与输入相同；</p><p>输入负数，比如-1、-1.2、-0.99，期待返回值与输入相反；</p><p>输入0，期待返回0；</p><p>输入非数值类型，比如null、[]、{}，期待抛出Error。</p><p>把上面的测试用例放到一个测试模块里，就是一个完整的单元测试。</p><p>如果单元测试通过，说明我们测试的这个函数能够正常工作。如果单元测试不通过，要么函数有bug，要么测试条件输入不正确，总之，需要修复使单元测试能够通过。</p><p>单元测试通过后有什么意义呢？如果我们对abs()函数代码做了修改，只需要再跑一遍单元测试，如果通过，说明我们的修改不会对abs()函数原有的行为造成影响，如果测试不通过，说明我们的修改与原有行为不一致，要么修改代码，要么修改测试。</p><p>这种以测试为驱动的开发模式最大的好处就是确保一个程序模块的行为符合我们设计的测试用例。在将来修改的时候，可以极大程度地保证该模块行为仍然是正确的。</p><p>mocha是JavaScript的一种单元测试框架，既可以在浏览器环境下运行，也可以在Node.js环境下运行。</p><p>使用mocha，我们就只需要专注于编写单元测试本身，然后，让mocha去自动运行所有的测试，并给出测试结果。</p><p>mocha的特点主要有：</p><ol><li>既可以测试简单的JavaScript函数，又可以测试异步代码，因为异步是JavaScript的特性之一；</li><li>可以自动运行所有测试，也可以只运行特定的测试；</li><li>可以支持before、after、beforeEach和afterEach来编写初始化代码。</li></ol><h5 class="relative group">1.编写测试<div id=1%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>assert</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;assert&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;../test&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;#hello.js&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;#sum()&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;sum() should return 0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>assert</span><span class=p>.</span><span class=nx>strictEqual</span><span class=p>(</span><span class=nx>sum</span><span class=p>(),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;sum(1) should return 1&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>assert</span><span class=p>.</span><span class=nx>strictEqual</span><span class=p>(</span><span class=nx>sum</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;sum(1, 2) should return 3&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>assert</span><span class=p>.</span><span class=nx>strictEqual</span><span class=p>(</span><span class=nx>sum</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;sum(1, 2, 3) should return 6&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>assert</span><span class=p>.</span><span class=nx>strictEqual</span><span class=p>(</span><span class=nx>sum</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><h5 class="relative group">2.chai断言库<div id=2chai%E6%96%AD%E8%A8%80%E5%BA%93 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2chai%E6%96%AD%E8%A8%80%E5%BA%93 aria-label=Anchor>#</a></span></h5><p><figure><img class="my-0 rounded-md" loading=lazy src=nodejs%E9%80%9F%E8%A7%88%E7%AC%94%E8%AE%B0.assets/image-20220505113605440.png alt=image-20220505113605440></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>chai</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;chai&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>assert</span> <span class=o>=</span> <span class=nx>chai</span><span class=p>.</span><span class=nx>assert</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;assert Demo&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;use assert lib&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=s2>&#34;hello&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>.</span><span class=nx>typeOf</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>chai</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;chai&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>chai</span><span class=p>.</span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;should Demo&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;use should lib&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;hello&#39;</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>exist</span><span class=p>.</span><span class=nx>and</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>).</span><span class=nx>and</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>length</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nx>and</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>a</span><span class=p>(</span><span class=s1>&#39;string&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// value.should.be.a(&#39;string&#39;)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// value.should.equal(&#39;hello&#39;)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// value.should.not.equal(&#39;hello2&#39;)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// value.should.have.length(5);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>chai</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;chai&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>expect</span> <span class=o>=</span> <span class=nx>chai</span><span class=p>.</span><span class=nx>expect</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;expect Demo&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;use expect lib&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;hello&#39;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>number</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>number</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>at</span><span class=p>.</span><span class=nx>most</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>number</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>at</span><span class=p>.</span><span class=nx>least</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>number</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>within</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>exist</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>a</span><span class=p>(</span><span class=s1>&#39;string&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=s1>&#39;您好&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>value</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>length</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><h5 class="relative group">3.异步测试<div id=3%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fs</span> <span class=o>=</span><span class=nx>require</span><span class=p>(</span><span class=s2>&#34;fs&#34;</span><span class=p>).</span><span class=nx>promises</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>chai</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;chai&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>expect</span> <span class=o>=</span> <span class=nx>chai</span><span class=p>.</span><span class=nx>expect</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>it</span><span class=p>(</span><span class=s1>&#39;test async function&#39;</span><span class=p>,</span><span class=kr>async</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span><span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;./1.txt&#39;</span><span class=p>,</span><span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>expect</span><span class=p>(</span><span class=nx>data</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=s1>&#39;hello&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><h5 class="relative group">4.http测试<div id=4http%E6%B5%8B%E8%AF%95 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4http%E6%B5%8B%E8%AF%95 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;supertest&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;../app&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;#test koa app&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;#test server&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;#test GET /&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>await</span> <span class=nx>request</span><span class=p>(</span><span class=nx>server</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>,</span> <span class=sr>/text\/html/</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s1>&#39;&lt;h1&gt;hello world&lt;/h1&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>after</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>server</span><span class=p>.</span><span class=nx>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><h5 class="relative group">5.钩子函数<div id=5%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0 aria-label=Anchor>#</a></span></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;#hello.js&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;#sum()&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>before</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;before:&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>after</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;after.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>beforeEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;  beforeEach:&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>afterEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;  afterEach.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div></div></section><section class="mt-10 prose dark:prose-invert"><p class="py-8 border-t"><em>There are no articles to list here yet.</em></p></section><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Hunger</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/hunger-blog/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js integrity="sha512-YgYLskf03itt3kWQNmj++2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://hunger-511.github.io/hunger-blog/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>